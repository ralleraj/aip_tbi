<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title>Dynamic model (HUS, KYS, TYKS) without GCS</title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1671.5">
  <style type="text/css">
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #161616; -webkit-text-stroke: #161616; background-color: #efefef}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; text-indent: 0.2px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #161616; -webkit-text-stroke: #161616}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #204a48; -webkit-text-stroke: #204a48; background-color: #efefef}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #135003; -webkit-text-stroke: #135003; background-color: #efefef}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #0000ff; -webkit-text-stroke: #0000ff; background-color: #efefef}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #161616; -webkit-text-stroke: #161616; background-color: #efefef; min-height: 11.0px}
    p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 11.0px}
    p.p12 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #161616; -webkit-text-stroke: #161616}
    p.p14 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff}
    p.p15 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; min-height: 11.0px}
    p.p16 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #820011; -webkit-text-stroke: #820011; background-color: #efefef}
    p.p17 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #85264f; -webkit-text-stroke: #85264f; background-color: #efefef}
    p.p18 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #323232; -webkit-text-stroke: #323232; background-color: #efefef}
    p.p19 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 11.0px; font: 9.0px 'Helvetica Neue'; color: #820011; -webkit-text-stroke: #820011}
    span.s1 {font-kerning: none; background-color: #ffffff}
    span.s2 {font-kerning: none}
    span.s3 {font-kerning: none; color: #323232; -webkit-text-stroke: 0px #323232}
    span.s4 {font-kerning: none; color: #323232; background-color: #efefef; -webkit-text-stroke: 0px #323232}
    span.s5 {font-kerning: none; background-color: #efefef}
    span.s6 {font-kerning: none; color: #000000; -webkit-text-stroke: 0px #000000}
    span.s7 {font-kerning: none; color: #161616; -webkit-text-stroke: 0px #161616}
    span.s8 {font-kerning: none; color: #0000ff; -webkit-text-stroke: 0px #0000ff}
    span.s9 {font-kerning: none; color: #135003; -webkit-text-stroke: 0px #135003}
    span.s10 {font-kerning: none; color: #820011; -webkit-text-stroke: 0px #820011}
    span.s11 {font-kerning: none; color: #135003; background-color: #efefef; -webkit-text-stroke: 0px #135003}
    span.s12 {font-kerning: none; color: #820011; background-color: #efefef; -webkit-text-stroke: 0px #820011}
    span.s13 {font: 12.0px 'Helvetica Neue'; font-kerning: none; color: #000000; -webkit-text-stroke: 0px #000000}
    span.s14 {font-kerning: none; color: #6e00ff; -webkit-text-stroke: 0px #6e00ff}
    span.s15 {font-kerning: none; color: #85264f; -webkit-text-stroke: 0px #85264f}
    span.s16 {font-kerning: none; color: #204a48; -webkit-text-stroke: 0px #204a48}
    span.s17 {font: 9.0px 'Helvetica Neue'; text-decoration: underline ; font-kerning: none; color: #193c85; -webkit-text-stroke: 0px #193c85}
    span.s18 {font-kerning: none; color: #852e12; -webkit-text-stroke: 0px #852e12}
    span.s19 {font-kerning: none; color: #161616; background-color: #efefef; -webkit-text-stroke: 0px #161616}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<h1 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 17.0px; font: 14.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Code for the ICP-MAP-CPP algorithm</b></span></h1>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 14.0px"><span class="s2"></span><br></h2>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Install required Python packages</b></span></h2>
<p class="p4"><span class="s3">!</span><span class="s2">conda update seaborn pandas -y</span></p>
<p class="p4"><span class="s3">!</span><span class="s2">pip install tqdm</span></p>
<p class="p5"><span class="s4">!</span><span class="s5">pip install bayesian-optimization</span><span class="s6"><br>
</span></p>
<p class="p6"><span class="s1">Once the packages have been installed, click Reset Session / Restart from the panel. You can also run 'Clear all Cells' from the Clear dropdown menu.</span></p>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 14.0px"><span class="s2"></span><br></h2>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Create folder structure for images</b></span></h2>
<p class="p4"><span class="s3">!</span><span class="s2">mkdir images</span></p>
<p class="p4"><span class="s3">!</span><span class="s2">mkdir images/without_gcs</span></p>
<p class="p4"><span class="s3">!</span><span class="s2">mkdir images/without_gcs/survived</span></p>
<p class="p4"><span class="s3">!</span><span class="s2">mkdir images/without_gcs/deceased</span></p>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 14.0px"><span class="s2"></span><br></h2>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Load data</b></span></h2>
<p class="p6"><span class="s1">The data resides in the Google Cloud BigQuery data warehouse. In this section we load the data into Pandas dataframes for analysis.</span><span class="s2"><br>
</span></p>
<p class="p7"><span class="s2"><i># standard data science libraries</i></span></p>
<p class="p8"><span class="s2"><b>import</b></span><span class="s7"> </span><span class="s8"><b>pandas</b></span><span class="s7"> </span><span class="s2"><b>as</b></span><span class="s7"> </span><span class="s8"><b>pd</b></span></p>
<p class="p8"><span class="s2"><b>import</b></span><span class="s7"> </span><span class="s8"><b>numpy</b></span><span class="s7"> </span><span class="s2"><b>as</b></span><span class="s7"> </span><span class="s8"><b>np</b></span></p>
<p class="p9"><span class="s9"><b>import</b></span><span class="s7"> </span><span class="s2"><b>seaborn</b></span><span class="s7"> </span><span class="s9"><b>as</b></span><span class="s7"> </span><span class="s2"><b>sns</b></span></p>
<p class="p9"><span class="s9"><b>import</b></span><span class="s7"> </span><span class="s2"><b>matplotlib.pyplot</b></span><span class="s7"> </span><span class="s9"><b>as</b></span><span class="s7"> </span><span class="s2"><b>plt</b></span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s2"><i># Google BigQuery API</i></span></p>
<p class="p9"><span class="s9"><b>import</b></span><span class="s7"> </span><span class="s2"><b>google.datalab.bigquery</b></span><span class="s7"> </span><span class="s9"><b>as</b></span><span class="s7"> </span><span class="s2"><b>bq</b></span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s2"><i># libraries for HTML display and progress bars</i></span></p>
<p class="p9"><span class="s9"><b>from</b></span><span class="s7"> </span><span class="s2"><b>IPython.display</b></span><span class="s7"> </span><span class="s9"><b>import</b></span><span class="s7"> HTML</span></p>
<p class="p4"><span class="s9"><b>from</b></span><span class="s2"> </span><span class="s8"><b>tqdm</b></span><span class="s2"> </span><span class="s9"><b>import</b></span><span class="s2"> tqdm_notebook</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">The data is arranged into three datasets. The raw data from HUS and KYS is processed into patient_data and then combined in combined_patient_data, as explained in other notebooks.</span></p>
<p class="p4"><span class="s3">%%</span><span class="s9"><b>bq</b></span><span class="s2"> datasets list</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">A quick peek into the patients dataset shows the patient ids (4-1692 for HUS patients, 12220-150050 for KYS patients and 74000-14910000 for TYKS patients), the targets dead30 and age categories.</span></p>
<p class="p4"><span class="s3">%%</span><span class="s9"><b>bq</b></span><span class="s2"> query -n patients</span></p>
<p class="p4"><span class="s2">SELECT id, agecat, dead30</span></p>
<p class="p4"><span class="s2">FROM `combined_patient_data.patients_HUS_KYS_TYKS`</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">The monitor data with ICP and MAP are stored in a BigQuery view format with the following schema.</span></p>
<p class="p4"><span class="s3">%%</span><span class="s9"><b>bq</b></span><span class="s2"> tables describe -n combined_patient_data.ICP_HUS_KYS_TYKS</span></p>
<p class="p4"><span class="s3">%%</span><span class="s9"><b>bq</b></span><span class="s2"> query -n ICP</span></p>
<p class="p4"><span class="s2">SELECT id, delta_icp as delta, value</span></p>
<p class="p4"><span class="s2">FROM `combined_patient_data.ICP_HUS_KYS_TYKS`</span></p>
<p class="p4"><span class="s2">ORDER BY id, delta</span></p>
<p class="p4"><span class="s3">%%</span><span class="s9"><b>bq</b></span><span class="s2"> query -n MAP</span></p>
<p class="p4"><span class="s2">SELECT id, delta_icp as delta, value</span></p>
<p class="p4"><span class="s2">FROM `combined_patient_data.MAP_HUS_KYS_TYKS`</span></p>
<p class="p4"><span class="s2">ORDER BY id, delta</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">CPP is then computed by the formula CPP = MAP - ICP.</span></p>
<p class="p4"><span class="s3">%%</span><span class="s9"><b>bq</b></span><span class="s2"> query -n CPP</span></p>
<p class="p4"><span class="s2">SELECT</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>icp.id AS id,</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>icp.delta_icp AS delta,</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>map.value - icp.value AS value</span></p>
<p class="p4"><span class="s2">FROM</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>`combined_patient_data.ICP_HUS_KYS_TYKS` AS icp</span></p>
<p class="p4"><span class="s2">INNER JOIN</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>`combined_patient_data.MAP_HUS_KYS_TYKS` AS map</span></p>
<p class="p4"><span class="s2">ON map.id = icp.id AND map.delta_icp = icp.delta_icp</span></p>
<p class="p4"><span class="s2">ORDER BY id, delta</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">We store the query results into dataframes.</span></p>
<p class="p4"><span class="s2">df_patients </span><span class="s3">=</span><span class="s2"> patients</span><span class="s3">.</span><span class="s2">execute(output_options</span><span class="s3">=</span><span class="s2">bq</span><span class="s3">.</span><span class="s2">QueryOutput</span><span class="s3">.</span><span class="s2">dataframe())</span><span class="s3">.</span><span class="s2">result()</span></p>
<p class="p4"><span class="s2">df_icp </span><span class="s3">=</span><span class="s2"> ICP</span><span class="s3">.</span><span class="s2">execute(output_options</span><span class="s3">=</span><span class="s2">bq</span><span class="s3">.</span><span class="s2">QueryOutput</span><span class="s3">.</span><span class="s2">dataframe())</span><span class="s3">.</span><span class="s2">result()</span></p>
<p class="p4"><span class="s2">df_map </span><span class="s3">=</span><span class="s2"> MAP</span><span class="s3">.</span><span class="s2">execute(output_options</span><span class="s3">=</span><span class="s2">bq</span><span class="s3">.</span><span class="s2">QueryOutput</span><span class="s3">.</span><span class="s2">dataframe())</span><span class="s3">.</span><span class="s2">result()</span></p>
<p class="p4"><span class="s2">df_cpp </span><span class="s3">=</span><span class="s2"> CPP</span><span class="s3">.</span><span class="s2">execute(output_options</span><span class="s3">=</span><span class="s2">bq</span><span class="s3">.</span><span class="s2">QueryOutput</span><span class="s3">.</span><span class="s2">dataframe())</span><span class="s3">.</span><span class="s2">result()</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">Our time parameter delta is calibrated with the first ICP measurement. We therefore drop all prior measurements of MAP and CPP.</span></p>
<p class="p4"><span class="s2">df_map </span><span class="s3">=</span><span class="s2"> df_map</span><span class="s3">.</span><span class="s2">drop(df_map[df_map</span><span class="s3">.</span><span class="s2">delta </span><span class="s3">&lt;</span><span class="s2"> </span><span class="s3">0</span><span class="s2">]</span><span class="s3">.</span><span class="s2">index)</span></p>
<p class="p4"><span class="s2">df_cpp </span><span class="s3">=</span><span class="s2"> df_cpp</span><span class="s3">.</span><span class="s2">drop(df_cpp[df_cpp</span><span class="s3">.</span><span class="s2">delta </span><span class="s3">&lt;</span><span class="s2"> </span><span class="s3">0</span><span class="s2">]</span><span class="s3">.</span><span class="s2">index)</span></p>
<p class="p7"><span class="s2"><i># Change data type of delta from float to timedelta.</i></span></p>
<p class="p4"><span class="s2">df_icp</span><span class="s3">.</span><span class="s2">delta </span><span class="s3">=</span><span class="s2"> df_icp</span><span class="s3">.</span><span class="s2">delta</span><span class="s3">.</span><span class="s2">map(</span><span class="s9"><b>lambda</b></span><span class="s2"> x: pd</span><span class="s3">.</span><span class="s2">to_timedelta(x,</span><span class="s10">'s'</span><span class="s2">))</span></p>
<p class="p4"><span class="s2">df_map</span><span class="s3">.</span><span class="s2">delta </span><span class="s3">=</span><span class="s2"> df_map</span><span class="s3">.</span><span class="s2">delta</span><span class="s3">.</span><span class="s2">map(</span><span class="s9"><b>lambda</b></span><span class="s2"> x: pd</span><span class="s3">.</span><span class="s2">to_timedelta(x,</span><span class="s10">'s'</span><span class="s2">))</span></p>
<p class="p12"><span class="s5">df_cpp</span><span class="s4">.</span><span class="s5">delta </span><span class="s4">=</span><span class="s5"> df_cpp</span><span class="s4">.</span><span class="s5">delta</span><span class="s4">.</span><span class="s5">map(</span><span class="s11"><b>lambda</b></span><span class="s5"> x: pd</span><span class="s4">.</span><span class="s5">to_timedelta(x,</span><span class="s12">'s'</span><span class="s5">))</span><span class="s13"><br>
</span></p>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff"><span class="s2"><b>Create features</b></span></h2>
<p class="p14"><span class="s2">In our case, the most crucial part in preparing the model is feature engineering. We will analyse the monitor data time series using four hour rolling windows. In these windows we compute various statistics and inspect their trends, which results in a number of derived time series. Finally, we turn these derived series into features by computing value averages over initial 24h and final 8h windows, and including a linear trend coefficient.</span></p>
<p class="p15"><span class="s2"></span><br></p>
<p class="p9"><span class="s9"><b>from</b></span><span class="s7"> </span><span class="s2"><b>sklearn.linear_model</b></span><span class="s7"> </span><span class="s9"><b>import</b></span><span class="s7"> LinearRegression</span></p>
<p class="p4"><span class="s9"><b>def</b></span><span class="s2"> </span><span class="s8">create_derived_series</span><span class="s2">(df_patients, df_icp, df_map, df_cpp):</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i>""" This function derives various new time series for each patient from the original ICP, MAP, and CPP data. """</i></span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># Take the intersection of available patient ids.</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ids </span><span class="s3">=</span><span class="s2"> </span><span class="s9">list</span><span class="s2">(</span><span class="s9">set</span><span class="s2">(df_patients[</span><span class="s10">'id'</span><span class="s2">]) </span><span class="s3">&amp;</span><span class="s2"> </span><span class="s9">set</span><span class="s2">(df_icp[</span><span class="s10">'id'</span><span class="s2">]) </span><span class="s3">&amp;</span><span class="s2"> </span><span class="s9">set</span><span class="s2">(df_map[</span><span class="s10">'id'</span><span class="s2">]))</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># The dictionary below holds various types of derived series as keys the values of which are dictionaries indexed by patient ids.</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># To add a new type of derived series, make and empty entry to the dictionary and provide a logic for its computation for each patient in the for loop below.</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>derived_series </span><span class="s3">=</span><span class="s2"> {</span><span class="s10">'icp'</span><span class="s2">: {}, </span><span class="s10">'map'</span><span class="s2">: {}, </span><span class="s10">'cpp'</span><span class="s2">: {},</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                    </span></span><span class="s10">'icp_var'</span><span class="s2">: {}, </span><span class="s10">'map_var'</span><span class="s2">: {}, </span><span class="s10">'cpp_var'</span><span class="s2">: {},</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                    </span></span><span class="s10">'icp_ht20'</span><span class="s2">: {}, </span><span class="s10">'map_ht120'</span><span class="s2">: {}, </span><span class="s10">'icp_lt10'</span><span class="s2">: {},</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                    </span></span><span class="s10">'icp_diff'</span><span class="s2">: {}, </span><span class="s10">'map_diff'</span><span class="s2">: {}, </span><span class="s10">'cpp_diff'</span><span class="s2">: {},</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                    </span></span><span class="s10">'icp_q10'</span><span class="s2">: {}, </span><span class="s10">'icp_q90'</span><span class="s2">: {},</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                    </span></span><span class="s10">'map_q10'</span><span class="s2">: {}, </span><span class="s10">'map_q90'</span><span class="s2">: {},</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                    </span></span><span class="s10">'cpp_q10'</span><span class="s2">: {}, </span><span class="s10">'cpp_q90'</span><span class="s2">: {}}</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># Set the length of the rolling window. Feel free to experiment with values other than '4h'.</i></span></p>
<p class="p12"><span class="s5"><span class="Apple-converted-space">  </span>rolling_window_length </span><span class="s4">=</span><span class="s5"> </span><span class="s12">'4h'</span><span class="s5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span><span class="s2"><br>
</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># Loop over patient ids and<span class="Apple-converted-space"> </span></i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>for</b></span><span class="s2"> i </span><span class="s14"><b>in</b></span><span class="s2"> tqdm_notebook(ids, ncols</span><span class="s3">=1000</span><span class="s2">, desc</span><span class="s3">=</span><span class="s10">"Create series"</span><span class="s2">):</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">    </span></span><span class="s2"><i># data as is</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'icp'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_icp[df_icp[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'map'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_map[df_map[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'cpp'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_cpp[df_cpp[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">    </span></span><span class="s2"><i># variance</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'icp_var'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_icp[df_icp[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">var()</span><span class="s3">.</span><span class="s2">dropna()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'map_var'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_map[df_map[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">var()</span><span class="s3">.</span><span class="s2">dropna()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'cpp_var'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_cpp[df_cpp[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">var()</span><span class="s3">.</span><span class="s2">dropna()</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">    </span></span><span class="s2"><i># cut-off percentage</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'icp_ht20'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_icp[df_icp[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">apply(</span><span class="s9"><b>lambda</b></span><span class="s2"> window: </span><span class="s3">100*</span><span class="s2">(window </span><span class="s3">&gt;</span><span class="s2"> </span><span class="s3">20</span><span class="s2">)</span><span class="s3">.</span><span class="s2">mean(), raw</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'map_ht120'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_map[df_map[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">apply(</span><span class="s9"><b>lambda</b></span><span class="s2"> window: </span><span class="s3">100*</span><span class="s2">(window </span><span class="s3">&gt;</span><span class="s2"> </span><span class="s3">120</span><span class="s2">)</span><span class="s3">.</span><span class="s2">mean(), raw</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'icp_lt10'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_icp[df_icp[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">apply(</span><span class="s9"><b>lambda</b></span><span class="s2"> window: </span><span class="s3">100*</span><span class="s2">(window </span><span class="s3">&lt;</span><span class="s2"> </span><span class="s3">10</span><span class="s2">)</span><span class="s3">.</span><span class="s2">mean(), raw</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">)</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">    </span></span><span class="s2"><i># magnitude of difference</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'icp_diff'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_icp[df_icp[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">diff()</span><span class="s3">.</span><span class="s2">abs()</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">mean()</span><span class="s3">.</span><span class="s2">dropna()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'map_diff'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_map[df_map[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">diff()</span><span class="s3">.</span><span class="s2">abs()</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">mean()</span><span class="s3">.</span><span class="s2">dropna()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'cpp_diff'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_cpp[df_cpp[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">diff()</span><span class="s3">.</span><span class="s2">abs()</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">mean()</span><span class="s3">.</span><span class="s2">dropna()</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">    </span></span><span class="s2"><i># quantile</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'icp_q10'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_icp[df_icp[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">quantile(</span><span class="s3">0.1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">dropna()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'icp_q90'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_icp[df_icp[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">quantile(</span><span class="s3">0.9</span><span class="s2">)</span><span class="s3">.</span><span class="s2">dropna()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'map_q10'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_map[df_map[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">quantile(</span><span class="s3">0.1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">dropna()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'map_q90'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_map[df_map[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">quantile(</span><span class="s3">0.9</span><span class="s2">)</span><span class="s3">.</span><span class="s2">dropna()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'cpp_q10'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_cpp[df_cpp[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">quantile(</span><span class="s3">0.1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">dropna()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>derived_series[</span><span class="s10">'cpp_q90'</span><span class="s2">][i] </span><span class="s3">=</span><span class="s2"> df_cpp[df_cpp[</span><span class="s10">'id'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'id'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'delta'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">rolling(rolling_window_length)</span><span class="s3">.</span><span class="s2">quantile(</span><span class="s3">0.9</span><span class="s2">)</span><span class="s3">.</span><span class="s2">dropna()</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">    </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>return</b></span><span class="s2"> derived_series</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">To get an idea how the derived series look we plot one of them.</span></p>
<p class="p4"><span class="s2">derived_series </span><span class="s3">=</span><span class="s2"> create_derived_series(df_patients, df_icp, df_map, df_cpp)</span></p>
<p class="p16"><span class="s7">name </span><span class="s3">=</span><span class="s7"> </span><span class="s2">'icp_diff'</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> i </span><span class="s14"><b>in</b></span><span class="s2"> survived:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">figure(figsize</span><span class="s3">=</span><span class="s2">(</span><span class="s3">15</span><span class="s2">,</span><span class="s3">5</span><span class="s2">))</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">title(</span><span class="s10">'Patient </span><span class="s15"><b>{}</b></span><span class="s10">, survived'</span><span class="s3">.</span><span class="s2">format(i))</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">plot(derived_series[name][i]</span><span class="s3">.</span><span class="s2">index</span><span class="s3">.</span><span class="s2">map(</span><span class="s9"><b>lambda</b></span><span class="s2"> x: x</span><span class="s3">.</span><span class="s2">total_seconds() </span><span class="s3">/</span><span class="s2"> </span><span class="s3">60</span><span class="s2"> </span><span class="s3">/</span><span class="s2"> </span><span class="s3">60</span><span class="s2">), derived_series[name][i], color</span><span class="s3">=</span><span class="s10">'darkorange'</span><span class="s2">, label</span><span class="s3">=</span><span class="s2">name)</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s7">xlabel(</span><span class="s2">"Time passed (hours)"</span><span class="s7">)</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s9"><b>if</b></span><span class="s7"> name </span><span class="s14"><b>in</b></span><span class="s7"> [</span><span class="s2">'icp_ht20'</span><span class="s7">, </span><span class="s2">'map_ht120'</span><span class="s7">, </span><span class="s2">'icp_lt10'</span><span class="s7">]:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>plt</span><span class="s3">.</span><span class="s2">ylabel(</span><span class="s10">'%'</span><span class="s2">)</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s9"><b>elif</b></span><span class="s7"> name </span><span class="s14"><b>in</b></span><span class="s7"> [</span><span class="s2">'icp_var'</span><span class="s7">, </span><span class="s2">'map_var'</span><span class="s7">, </span><span class="s2">'cpp_var'</span><span class="s7">]:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>plt</span><span class="s3">.</span><span class="s2">ylabel(</span><span class="s10">'mmHg^2'</span><span class="s2">)</span></p>
<p class="p8"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><b>else</b></span><span class="s7">:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>plt</span><span class="s3">.</span><span class="s2">ylabel(</span><span class="s10">'mmHg'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">legend(loc</span><span class="s3">=1</span><span class="s2">)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> i </span><span class="s14"><b>in</b></span><span class="s2"> deceased:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">figure(figsize</span><span class="s3">=</span><span class="s2">(</span><span class="s3">15</span><span class="s2">,</span><span class="s3">5</span><span class="s2">))</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">title(</span><span class="s10">'Patient </span><span class="s15"><b>{}</b></span><span class="s10">, deceased'</span><span class="s3">.</span><span class="s2">format(i))</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">plot(derived_series[name][i]</span><span class="s3">.</span><span class="s2">index</span><span class="s3">.</span><span class="s2">map(</span><span class="s9"><b>lambda</b></span><span class="s2"> x: x</span><span class="s3">.</span><span class="s2">total_seconds() </span><span class="s3">/</span><span class="s2"> </span><span class="s3">60</span><span class="s2"> </span><span class="s3">/</span><span class="s2"> </span><span class="s3">60</span><span class="s2">), derived_series[name][i], label</span><span class="s3">=</span><span class="s2">name)</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s7">xlabel(</span><span class="s2">"Time passed (hours)"</span><span class="s7">)</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s9"><b>if</b></span><span class="s7"> name </span><span class="s14"><b>in</b></span><span class="s7"> [</span><span class="s2">'icp_ht20'</span><span class="s7">, </span><span class="s2">'map_ht120'</span><span class="s7">, </span><span class="s2">'icp_lt10'</span><span class="s7">]:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>plt</span><span class="s3">.</span><span class="s2">ylabel(</span><span class="s10">'%'</span><span class="s2">)</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s9"><b>elif</b></span><span class="s7"> name </span><span class="s14"><b>in</b></span><span class="s7"> [</span><span class="s2">'icp_var'</span><span class="s7">, </span><span class="s2">'map_var'</span><span class="s7">, </span><span class="s2">'cpp_var'</span><span class="s7">]:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>plt</span><span class="s3">.</span><span class="s2">ylabel(</span><span class="s10">'mmHg^2'</span><span class="s2">)</span></p>
<p class="p8"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><b>else</b></span><span class="s7">:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>plt</span><span class="s3">.</span><span class="s2">ylabel(</span><span class="s10">'mmHg'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">legend(loc</span><span class="s3">=1</span><span class="s2">)</span></p>
<p class="p9"><span class="s9"><b>def</b></span><span class="s7"> </span><span class="s2">compute_features</span><span class="s7">(series):</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i>""" For a given time series, compute the initial 24h mean, the final 8h mean, and the regression coefficient. """</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>begin_mean </span><span class="s3">=</span><span class="s2"> series[series</span><span class="s3">.</span><span class="s2">index </span><span class="s3">&lt;</span><span class="s2"> pd</span><span class="s3">.</span><span class="s2">to_timedelta(</span><span class="s10">'24h'</span><span class="s2">)][</span><span class="s10">'value'</span><span class="s2">]</span><span class="s3">.</span><span class="s2">mean()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>end_mean </span><span class="s3">=</span><span class="s2"> series[series</span><span class="s3">.</span><span class="s2">index </span><span class="s3">&gt;</span><span class="s2"> series</span><span class="s3">.</span><span class="s2">index</span><span class="s3">.</span><span class="s2">values[</span><span class="s3">-1</span><span class="s2">] </span><span class="s3">-</span><span class="s2"> pd</span><span class="s3">.</span><span class="s2">to_timedelta(</span><span class="s10">'8h'</span><span class="s2">)][</span><span class="s10">'value'</span><span class="s2">]</span><span class="s3">.</span><span class="s2">mean()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>coef </span><span class="s3">=</span><span class="s2"> LinearRegression()</span><span class="s3">.</span><span class="s2">fit(series</span><span class="s3">.</span><span class="s2">index</span><span class="s3">.</span><span class="s2">values</span><span class="s3">.</span><span class="s2">reshape(</span><span class="s3">-1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">), series[</span><span class="s10">'value'</span><span class="s2">])</span><span class="s3">.</span><span class="s2">coef_[</span><span class="s3">0</span><span class="s2">]</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>return</b></span><span class="s2"> begin_mean, end_mean, coef</span></p>
<p class="p4"><span class="s9"><b>def</b></span><span class="s2"> </span><span class="s8">prepare_data</span><span class="s2">(df_patients, df_icp, df_map, df_cpp):</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i>""" This function prepares the full dataframe of features from the patient and monitor data. """</i></span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ids </span><span class="s3">=</span><span class="s2"> </span><span class="s9">list</span><span class="s2">(</span><span class="s9">set</span><span class="s2">(df_patients[</span><span class="s10">'id'</span><span class="s2">]) </span><span class="s3">&amp;</span><span class="s2"> </span><span class="s9">set</span><span class="s2">(df_icp[</span><span class="s10">'id'</span><span class="s2">]) </span><span class="s3">&amp;</span><span class="s2"> </span><span class="s9">set</span><span class="s2">(df_map[</span><span class="s10">'id'</span><span class="s2">]))</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>derived_series </span><span class="s3">=</span><span class="s2"> create_derived_series(df_patients, df_icp, df_map, df_cpp)</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># For each type of derived series, initialize a dataframe with begin, end, and coef features.</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>feature_dfs </span><span class="s3">=</span><span class="s2"> {name: pd</span><span class="s3">.</span><span class="s2">DataFrame(index</span><span class="s3">=</span><span class="s2">ids, columns</span><span class="s3">=</span><span class="s2">[name </span><span class="s3">+</span><span class="s2"> </span><span class="s10">'_begin'</span><span class="s2">, name </span><span class="s3">+</span><span class="s2"> </span><span class="s10">'_end'</span><span class="s2">, name </span><span class="s3">+</span><span class="s2"> </span><span class="s10">'_coef'</span><span class="s2">], dtype</span><span class="s3">=</span><span class="s2">np</span><span class="s3">.</span><span class="s2">float32) </span><span class="s9"><b>for</b></span><span class="s2"> name </span><span class="s14"><b>in</b></span><span class="s2"> derived_series}</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>series </span><span class="s3">=</span><span class="s2"> tqdm_notebook(derived_series, ncols</span><span class="s3">=1000</span><span class="s2">)</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># For each type of derived series populate the corresponding feature dataframe by computing the features for each patient.</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>for</b></span><span class="s2"> name </span><span class="s14"><b>in</b></span><span class="s2"> series:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>series</span><span class="s3">.</span><span class="s2">set_description(</span><span class="s10">"</span><span class="s15"><b>%s</b></span><span class="s10">"</span><span class="s2"> </span><span class="s3">%</span><span class="s2"> name)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s9"><b>for</b></span><span class="s2"> i </span><span class="s14"><b>in</b></span><span class="s2"> ids:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">      </span></span><span class="s9"><b>try</b></span><span class="s2">: <span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">        </span>feature_dfs[name]</span><span class="s3">.</span><span class="s2">loc[i] </span><span class="s3">=</span><span class="s2"> compute_features(derived_series[name][i])</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">      </span></span><span class="s9"><b>except</b></span><span class="s2">:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">        </span></span><span class="s9"><b>continue</b></span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># Join all the feature dataframes with the patients data.</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>monitordata </span><span class="s3">=</span><span class="s2"> df_patients</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'id'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">join(feature_dfs</span><span class="s3">.</span><span class="s2">values(), how</span><span class="s3">=</span><span class="s10">'inner'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>monitordata</span><span class="s3">.</span><span class="s2">dropna(inplace</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>monitordata </span><span class="s3">=</span><span class="s2"> monitordata</span><span class="s3">.</span><span class="s2">sample(frac</span><span class="s3">=1</span><span class="s2">) </span><span class="s16"><i># Shuffle the dataframe.</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>data </span><span class="s3">=</span><span class="s2"> monitordata</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'dead30'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>target </span><span class="s3">=</span><span class="s2"> monitordata[</span><span class="s10">'dead30'</span><span class="s2">]</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>return</b></span><span class="s2"> data, target</span></p>
<p class="p4"><span class="s9"><b>def</b></span><span class="s2"> </span><span class="s8">multiprocess_prepare_data</span><span class="s2">(df_patients, df_icp, df_map, df_cpp, return_dict, hour):</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i>""" This function prepares the full dataframe of features from the patient and monitor data. """</i></span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ids </span><span class="s3">=</span><span class="s2"> </span><span class="s9">list</span><span class="s2">(</span><span class="s9">set</span><span class="s2">(df_patients[</span><span class="s10">'id'</span><span class="s2">]) </span><span class="s3">&amp;</span><span class="s2"> </span><span class="s9">set</span><span class="s2">(df_icp[</span><span class="s10">'id'</span><span class="s2">]) </span><span class="s3">&amp;</span><span class="s2"> </span><span class="s9">set</span><span class="s2">(df_map[</span><span class="s10">'id'</span><span class="s2">]))</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>derived_series </span><span class="s3">=</span><span class="s2"> create_derived_series(df_patients, df_icp, df_map, df_cpp)</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># For each type of derived series, initialize a dataframe with begin, end, and coef features.</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>feature_dfs </span><span class="s3">=</span><span class="s2"> {name: pd</span><span class="s3">.</span><span class="s2">DataFrame(index</span><span class="s3">=</span><span class="s2">ids, columns</span><span class="s3">=</span><span class="s2">[name </span><span class="s3">+</span><span class="s2"> </span><span class="s10">'_begin'</span><span class="s2">, name </span><span class="s3">+</span><span class="s2"> </span><span class="s10">'_end'</span><span class="s2">, name </span><span class="s3">+</span><span class="s2"> </span><span class="s10">'_coef'</span><span class="s2">], dtype</span><span class="s3">=</span><span class="s2">np</span><span class="s3">.</span><span class="s2">float32) </span><span class="s9"><b>for</b></span><span class="s2"> name </span><span class="s14"><b>in</b></span><span class="s2"> derived_series}</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>series </span><span class="s3">=</span><span class="s2"> tqdm_notebook(derived_series, ncols</span><span class="s3">=1000</span><span class="s2">)</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># For each type of derived series populate the corresponding feature dataframe by computing the features for each patient.</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>for</b></span><span class="s2"> name </span><span class="s14"><b>in</b></span><span class="s2"> series:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>series</span><span class="s3">.</span><span class="s2">set_description(</span><span class="s10">"</span><span class="s15"><b>%s</b></span><span class="s10">"</span><span class="s2"> </span><span class="s3">%</span><span class="s2"> name)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s9"><b>for</b></span><span class="s2"> i </span><span class="s14"><b>in</b></span><span class="s2"> ids:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">      </span></span><span class="s9"><b>try</b></span><span class="s2">: <span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">        </span>feature_dfs[name]</span><span class="s3">.</span><span class="s2">loc[i] </span><span class="s3">=</span><span class="s2"> compute_features(derived_series[name][i])</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">      </span></span><span class="s9"><b>except</b></span><span class="s2">:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">        </span></span><span class="s9"><b>continue</b></span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># Join all the feature dataframes with the patients data.</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>monitordata </span><span class="s3">=</span><span class="s2"> df_patients</span><span class="s3">.</span><span class="s2">set_index(</span><span class="s10">'id'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">join(feature_dfs</span><span class="s3">.</span><span class="s2">values(), how</span><span class="s3">=</span><span class="s10">'inner'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>monitordata</span><span class="s3">.</span><span class="s2">dropna(inplace</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>monitordata </span><span class="s3">=</span><span class="s2"> monitordata</span><span class="s3">.</span><span class="s2">sample(frac</span><span class="s3">=1</span><span class="s2">) </span><span class="s16"><i># Shuffle the dataframe.</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>data </span><span class="s3">=</span><span class="s2"> monitordata</span><span class="s3">.</span><span class="s2">drop(</span><span class="s10">'dead30'</span><span class="s2">, axis</span><span class="s3">=1</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>target </span><span class="s3">=</span><span class="s2"> monitordata[</span><span class="s10">'dead30'</span><span class="s2">]</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>return_dict[hour] </span><span class="s3">=</span><span class="s2"> data</span></p>
<p class="p4"><span class="s2">data_full, target </span><span class="s3">=</span><span class="s2"> prepare_data(df_patients, df_icp, df_map, df_cpp)</span></p>
<p class="p4"><span class="s2">data_full</span><span class="s3">.</span><span class="s2">info()</span></p>
<p class="p16"><span class="s9">print</span><span class="s7">(</span><span class="s2">'Number of patients: </span><span class="s15"><b>{}</b></span><span class="s2">'</span><span class="s3">.</span><span class="s7">format(</span><span class="s9">len</span><span class="s7">(target)))</span></p>
<p class="p16"><span class="s9">print</span><span class="s7">(</span><span class="s2">'Survived at least 30 days: </span><span class="s15"><b>{}</b></span><span class="s2">'</span><span class="s3">.</span><span class="s7">format(</span><span class="s9">len</span><span class="s7">(target[target </span><span class="s3">==</span><span class="s7"> </span><span class="s3">0.0</span><span class="s7">])))</span></p>
<p class="p4"><span class="s9">print</span><span class="s2">(</span><span class="s10">'Deceased within 30 days: </span><span class="s15"><b>{}</b></span><span class="s10">'</span><span class="s3">.</span><span class="s2">format(</span><span class="s9">len</span><span class="s2">(target[target </span><span class="s3">==</span><span class="s2"> </span><span class="s3">1.0</span><span class="s2">])))</span></p>
<p class="p4"><span class="s9">print</span><span class="s2">(</span><span class="s10">'Percentage of deceased: </span><span class="s15"><b>{}</b></span><span class="s10">%'</span><span class="s3">.</span><span class="s2">format(np</span><span class="s3">.</span><span class="s2">round(</span><span class="s3">100</span><span class="s2"> </span><span class="s3">*</span><span class="s2"> </span><span class="s9">len</span><span class="s2">(target[target </span><span class="s3">==</span><span class="s2"> </span><span class="s3">1.0</span><span class="s2">]) </span><span class="s3">/</span><span class="s2"> </span><span class="s9">len</span><span class="s2">(target), </span><span class="s3">2</span><span class="s2">)))</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">A class imbalance exists but is not critical.</span></p>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 14.0px"><span class="s2"></span><br></h2>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Inspecting the folding methods for cross-validation.</b></span></h2>
<p class="p6"><span class="s1">Due to the small size of the dataset, we use 5-fold cross-validation throughout the rest of the notebook. Before proceeding further we demonstrate the outcome of a number of folding methods. See <a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.KFold.html"><span class="s17">K-fold</span></a>, <a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.StratifiedKFold.html"><span class="s17">stratified K-fold</span></a>, and <a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.RepeatedStratifiedKFold.html"><span class="s17">repeated stratified K-fold</span></a>. We use stratified K-fold in order to retain the target distribution in train/test splits, and often its repeated version to average out fluctuations between splits.</span><span class="s2"><br>
</span></p>
<p class="p4"><span class="s9"><b>from</b></span><span class="s2"> </span><span class="s8"><b>sklearn.model_selection</b></span><span class="s2"> </span><span class="s9"><b>import</b></span><span class="s2"> KFold, StratifiedKFold, RepeatedStratifiedKFold</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s2"><i>#fold_method = KFold(n_splits=5, shuffle=True)</i></span></p>
<p class="p4"><span class="s2">fold_method </span><span class="s3">=</span><span class="s2"> StratifiedKFold(n_splits</span><span class="s3">=5</span><span class="s2">, shuffle</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">)</span></p>
<p class="p7"><span class="s2"><i>#fold_method = RepeatedStratifiedKFold(n_splits=5, n_repeats=10)</i></span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> splitnb, (train_index, test_index) </span><span class="s14"><b>in</b></span><span class="s2"> </span><span class="s9">enumerate</span><span class="s2">(fold_method</span><span class="s3">.</span><span class="s2">split(data_full, target)):</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9">print</span><span class="s2">(</span><span class="s10">'Split number </span><span class="s15"><b>{}</b></span><span class="s10">:'</span><span class="s3">.</span><span class="s2">format(splitnb </span><span class="s3">+</span><span class="s2"> </span><span class="s3">1</span><span class="s2">))</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9">print</span><span class="s2">(</span><span class="s10">'Number of train / test instances: </span><span class="s15"><b>{}</b></span><span class="s10"> / </span><span class="s15"><b>{}</b></span><span class="s10">'</span><span class="s3">.</span><span class="s2">format(</span><span class="s9">len</span><span class="s2">(train_index), </span><span class="s9">len</span><span class="s2">(test_index)))</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9">print</span><span class="s2">(</span><span class="s10">'</span><span class="s15"><b>% o</b></span><span class="s10">f deceased in train / test: </span><span class="s15"><b>{}</b></span><span class="s10">% / </span><span class="s15"><b>{}</b></span><span class="s10">%'</span><span class="s3">.</span><span class="s2">format(np</span><span class="s3">.</span><span class="s2">round(</span><span class="s3">100</span><span class="s2"> </span><span class="s3">*</span><span class="s2"> target</span><span class="s3">.</span><span class="s2">iloc[train_index]</span><span class="s3">.</span><span class="s2">mean(),</span><span class="s3">2</span><span class="s2">), np</span><span class="s3">.</span><span class="s2">round(</span><span class="s3">100</span><span class="s2"> </span><span class="s3">*</span><span class="s2"> target</span><span class="s3">.</span><span class="s2">iloc[test_index]</span><span class="s3">.</span><span class="s2">mean(),</span><span class="s3">2</span><span class="s2">)))</span></p>
<p class="p8"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2">print</span><span class="s7">()</span></p>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 14.0px"><span class="s2"></span><br></h2>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Normalize data &amp; select features</b></span></h2>
<p class="p14"><span class="s2">Normalize the data. Note that normalization is not required when using logistic regression. The normalization procedure has been left here to enable use of other types of regressors/classifiers, such as SVM.</span></p>
<p class="p15"><span class="s2"></span><br></p>
<p class="p9"><span class="s9"><b>from</b></span><span class="s7"> </span><span class="s2"><b>sklearn.preprocessing</b></span><span class="s7"> </span><span class="s9"><b>import</b></span><span class="s7"> StandardScaler</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">scaler </span><span class="s3">=</span><span class="s2"> StandardScaler()</span></p>
<p class="p4"><span class="s2">data_scaled </span><span class="s3">=</span><span class="s2"> pd</span><span class="s3">.</span><span class="s2">DataFrame(data</span><span class="s3">=</span><span class="s2">scaler</span><span class="s3">.</span><span class="s2">fit_transform(data_full), index</span><span class="s3">=</span><span class="s2">data_full</span><span class="s3">.</span><span class="s2">index, columns</span><span class="s3">=</span><span class="s2">data_full</span><span class="s3">.</span><span class="s2">columns)</span></p>
<p class="p6"><span class="s1">We select features using <a href="http://scikit-learn.org/stable/modules/generated/sklearn.feature_selection.RFECV.html"><span class="s17">recursive feature elimination</span></a>. Sets of features are evaluated by area under ROC curve in cross-validated logistic regression.</span></p>
<p class="p4"><span class="s9"><b>from</b></span><span class="s2"> </span><span class="s8"><b>sklearn.linear_model</b></span><span class="s2"> </span><span class="s9"><b>import</b></span><span class="s2"> LogisticRegression</span></p>
<p class="p9"><span class="s9"><b>from</b></span><span class="s7"> </span><span class="s2"><b>sklearn.feature_selection</b></span><span class="s7"> </span><span class="s9"><b>import</b></span><span class="s7"> RFECV</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">found </span><span class="s3">=</span><span class="s2"> </span><span class="s9"><b>False</b></span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s9"><b>while</b></span><span class="s2"> </span><span class="s14"><b>not</b></span><span class="s2"> found:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>lr </span><span class="s3">=</span><span class="s2"> LogisticRegression()</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>global</b></span><span class="s2"> rfecv</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>rfecv </span><span class="s3">=</span><span class="s2"> RFECV(estimator</span><span class="s3">=</span><span class="s2">lr, step</span><span class="s3">=1</span><span class="s2">, cv</span><span class="s3">=</span><span class="s2">RepeatedStratifiedKFold(n_splits</span><span class="s3">=5</span><span class="s2">, n_repeats</span><span class="s3">=10</span><span class="s2">), scoring</span><span class="s3">=</span><span class="s10">'roc_auc'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>rfecv</span><span class="s3">.</span><span class="s2">fit(data_scaled, target)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>if</b></span><span class="s2"> rfecv</span><span class="s3">.</span><span class="s2">n_features_ </span><span class="s3">&gt;=</span><span class="s2"> </span><span class="s3">8</span><span class="s2"> </span><span class="s14"><b>and</b></span><span class="s2"> rfecv</span><span class="s3">.</span><span class="s2">n_features_ </span><span class="s3">&lt;=18</span><span class="s2">:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>found </span><span class="s3">=</span><span class="s2"> </span><span class="s9"><b>True</b></span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">Plot number of features VS. cross-validation scores</span></p>
<p class="p4"><span class="s2">optimal_num_features </span><span class="s3">=</span><span class="s2"> rfecv</span><span class="s3">.</span><span class="s2">n_features_</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">figure(figsize</span><span class="s3">=</span><span class="s2">(</span><span class="s3">16</span><span class="s2">,</span><span class="s3">12</span><span class="s2">))</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">title(</span><span class="s10">"Optimal number of features: </span><span class="s15"><b>{}</b></span><span class="s10">"</span><span class="s3">.</span><span class="s2">format(optimal_num_features))</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">xlabel(</span><span class="s2">"Number of features selected"</span><span class="s7">)</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">ylabel(</span><span class="s2">"Cross-validation score (ROC AUC)"</span><span class="s7">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">plot(</span><span class="s9">range</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s9">len</span><span class="s2">(rfecv</span><span class="s3">.</span><span class="s2">grid_scores_) </span><span class="s3">+</span><span class="s2"> </span><span class="s3">1</span><span class="s2">), rfecv</span><span class="s3">.</span><span class="s2">grid_scores_)</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">savefig(</span><span class="s2">'images/without_gcs/feature_count.png'</span><span class="s7">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">show()</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">close()</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">Select the features.</span></p>
<p class="p4"><span class="s2">selected_columns </span><span class="s3">=</span><span class="s2"> data_scaled</span><span class="s3">.</span><span class="s2">columns[rfecv</span><span class="s3">.</span><span class="s2">support_]</span></p>
<p class="p4"><span class="s2">data </span><span class="s3">=</span><span class="s2"> data_scaled[selected_columns]</span></p>
<p class="p4"><span class="s2">display(HTML(</span><span class="s10">"Total of &lt;b&gt;</span><span class="s15"><b>{}</b></span><span class="s10">&lt;/b&gt; features considered:"</span><span class="s3">.</span><span class="s2">format(</span><span class="s9">len</span><span class="s2">(data_full</span><span class="s3">.</span><span class="s2">columns))))</span></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> num, column </span><span class="s14"><b>in</b></span><span class="s2"> </span><span class="s9">enumerate</span><span class="s2">(data_full</span><span class="s3">.</span><span class="s2">columns):</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s9">print</span><span class="s7">(column </span><span class="s3">+</span><span class="s7"> </span><span class="s2">'</span><span class="s18"><b>\n</b></span><span class="s2">'</span><span class="s7">, file</span><span class="s3">=</span><span class="s9">open</span><span class="s7">(</span><span class="s2">'images/without_gcs/tested_features.txt'</span><span class="s7">, </span><span class="s2">'a'</span><span class="s7">))</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9">print</span><span class="s2">(column</span><span class="s3">.</span><span class="s2">ljust(</span><span class="s3">20</span><span class="s2">), end</span><span class="s3">=</span><span class="s10">'</span><span class="s18"><b>\t</b></span><span class="s10">'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>if</b></span><span class="s2"> (num </span><span class="s3">+</span><span class="s2"> </span><span class="s3">1</span><span class="s2">) </span><span class="s3">%</span><span class="s2"> </span><span class="s3">5</span><span class="s2"> </span><span class="s3">==</span><span class="s2"> </span><span class="s3">0</span><span class="s2">:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s9">print</span><span class="s2">(</span><span class="s10">""</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">display(HTML(</span><span class="s10">"&lt;b&gt;</span><span class="s15"><b>{}</b></span><span class="s10">&lt;/b&gt; features selected:"</span><span class="s3">.</span><span class="s2">format(</span><span class="s9">len</span><span class="s2">(data</span><span class="s3">.</span><span class="s2">columns))))</span></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> num, column </span><span class="s14"><b>in</b></span><span class="s2"> </span><span class="s9">enumerate</span><span class="s2">(data</span><span class="s3">.</span><span class="s2">columns):</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9">print</span><span class="s2">(column</span><span class="s3">.</span><span class="s2">ljust(</span><span class="s3">20</span><span class="s2">), end</span><span class="s3">=</span><span class="s10">'</span><span class="s18"><b>\t</b></span><span class="s10">'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>if</b></span><span class="s2"> (num </span><span class="s3">+</span><span class="s2"> </span><span class="s3">1</span><span class="s2">) </span><span class="s3">%</span><span class="s2"> </span><span class="s3">5</span><span class="s2"> </span><span class="s3">==</span><span class="s2"> </span><span class="s3">0</span><span class="s2">:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s9">print</span><span class="s2">(</span><span class="s10">""</span><span class="s2">)</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">We plot the correlation matrix.</span></p>
<p class="p4"><span class="s2">fig, ax </span><span class="s3">=</span><span class="s2"> plt</span><span class="s3">.</span><span class="s2">subplots(figsize</span><span class="s3">=</span><span class="s2">(</span><span class="s3">25</span><span class="s2">,</span><span class="s3">20</span><span class="s2">))</span></p>
<p class="p4"><span class="s2">sns</span><span class="s3">.</span><span class="s2">set(font_scale</span><span class="s3">=1.4</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">sns</span><span class="s3">.</span><span class="s2">heatmap(data</span><span class="s3">.</span><span class="s2">corr(), annot</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">, fmt</span><span class="s3">=</span><span class="s10">".2f"</span><span class="s2">, ax</span><span class="s3">=</span><span class="s2">ax, cmap</span><span class="s3">=</span><span class="s10">"Blues"</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">show()</span></p>
<p class="p4"><span class="s2">sns</span><span class="s3">.</span><span class="s2">set(font_scale</span><span class="s3">=1.0</span><span class="s2">)</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">savefig(</span><span class="s2">'images/without_gcs/feature_correlations.png'</span><span class="s7">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">close()</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">Plot relative feature importances.</span></p>
<p class="p4"><span class="s2">lr </span><span class="s3">=</span><span class="s2"> LogisticRegression()</span></p>
<p class="p4"><span class="s2">lr</span><span class="s3">.</span><span class="s2">fit(data, target)</span></p>
<p class="p4"><span class="s2">feature_importance </span><span class="s3">=</span><span class="s2"> </span><span class="s9">abs</span><span class="s2">(lr</span><span class="s3">.</span><span class="s2">coef_[</span><span class="s3">0</span><span class="s2">])</span></p>
<p class="p4"><span class="s2">feature_importance </span><span class="s3">=</span><span class="s2"> </span><span class="s3">100.0</span><span class="s2"> </span><span class="s3">*</span><span class="s2"> (feature_importance </span><span class="s3">/</span><span class="s2"> feature_importance</span><span class="s3">.</span><span class="s2">max())</span></p>
<p class="p4"><span class="s2">sorted_idx </span><span class="s3">=</span><span class="s2"> np</span><span class="s3">.</span><span class="s2">argsort(feature_importance)</span></p>
<p class="p4"><span class="s2">pos </span><span class="s3">=</span><span class="s2"> np</span><span class="s3">.</span><span class="s2">arange(sorted_idx</span><span class="s3">.</span><span class="s2">shape[</span><span class="s3">0</span><span class="s2">]) </span><span class="s3">+</span><span class="s2"> </span><span class="s3">.5</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">featfig </span><span class="s3">=</span><span class="s2"> plt</span><span class="s3">.</span><span class="s2">figure(figsize</span><span class="s3">=</span><span class="s2">(</span><span class="s3">16</span><span class="s2">,</span><span class="s3">12</span><span class="s2">))</span></p>
<p class="p4"><span class="s2">featax </span><span class="s3">=</span><span class="s2"> featfig</span><span class="s3">.</span><span class="s2">add_subplot(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">featax</span><span class="s3">.</span><span class="s2">barh(pos, feature_importance[sorted_idx], align</span><span class="s3">=</span><span class="s10">'center'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">featax</span><span class="s3">.</span><span class="s2">set_yticks(pos)</span></p>
<p class="p4"><span class="s2">featax</span><span class="s3">.</span><span class="s2">set_yticklabels(np</span><span class="s3">.</span><span class="s2">array(data</span><span class="s3">.</span><span class="s2">columns)[sorted_idx], fontsize</span><span class="s3">=10</span><span class="s2">)</span></p>
<p class="p16"><span class="s7">featax</span><span class="s3">.</span><span class="s7">set_xlabel(</span><span class="s2">'Relative Feature Importance'</span><span class="s7">)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">savefig(</span><span class="s2">'images/without_gcs/relative_feature_importances.png'</span><span class="s7">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">show()</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">close()</span></p>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 14.0px"><span class="s2"></span><br></h2>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Fit models and cross-validate</b></span></h2>
<p class="p14"><span class="s2">We proceed to fitting and evaluating a logistic regression model. We will adjust the regularization coefficient C and the class weight w by using (black-box) Bayesian optimization.</span></p>
<p class="p15"><span class="s2"></span><br></p>
<p class="p9"><span class="s9"><b>from</b></span><span class="s7"> </span><span class="s2"><b>sklearn.model_selection</b></span><span class="s7"> </span><span class="s9"><b>import</b></span><span class="s7"> cross_validate</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s9"><b>def</b></span><span class="s2"> </span><span class="s8">lrcv</span><span class="s2">(C, w):</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>scoring </span><span class="s3">=</span><span class="s2"> [</span><span class="s10">'roc_auc'</span><span class="s2">]</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>scores </span><span class="s3">=</span><span class="s2"> cross_validate(LogisticRegression(C</span><span class="s3">=</span><span class="s2">C,<span class="Apple-converted-space">  </span>class_weight</span><span class="s3">=</span><span class="s2">{</span><span class="s3">0</span><span class="s2">:</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">:w}),<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                            </span>data,<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                            </span>target,<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                            </span>scoring</span><span class="s3">=</span><span class="s2">scoring,<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                            </span>cv</span><span class="s3">=</span><span class="s2">RepeatedStratifiedKFold(n_splits</span><span class="s3">=5</span><span class="s2">, n_repeats</span><span class="s3">=10</span><span class="s2">))</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>val </span><span class="s3">=</span><span class="s2"> scores[</span><span class="s10">'test_roc_auc'</span><span class="s2">]</span><span class="s3">.</span><span class="s2">mean()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s9"><b>return</b></span><span class="s2"> val</span></p>
<p class="p4"><span class="s9"><b>from</b></span><span class="s2"> </span><span class="s8"><b>bayes_opt</b></span><span class="s2"> </span><span class="s9"><b>import</b></span><span class="s2"> BayesianOptimization</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">gp_params </span><span class="s3">=</span><span class="s2"> {</span><span class="s10">"alpha"</span><span class="s2">: </span><span class="s3">1</span><span class="s2">e</span><span class="s3">-5</span><span class="s2">}</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">BO </span><span class="s3">=</span><span class="s2"> BayesianOptimization(lrcv, {</span><span class="s10">'C'</span><span class="s2">: (</span><span class="s3">0.01</span><span class="s2">,</span><span class="s3">10</span><span class="s2">), </span><span class="s10">'w'</span><span class="s2">: (</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">)})</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s7">BO</span><span class="s3">.</span><span class="s7">maximize(n_iter</span><span class="s3">=20</span><span class="s7">, </span><span class="s3">**</span><span class="s7">gp_params) </span><span class="s2"><i># Try increasing the n_iter parameter to run the optimization longer.</i></span></p>
<p class="p8"><span class="s2">print</span><span class="s7">(</span><span class="s10">'-'</span><span class="s7"> </span><span class="s3">*</span><span class="s7"> </span><span class="s3">53</span><span class="s7">)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p16"><span class="s9">print</span><span class="s7">(</span><span class="s2">'Final Results'</span><span class="s7">)</span></p>
<p class="p16"><span class="s9">print</span><span class="s7">(</span><span class="s2">'Classifier: </span><span class="s15"><b>%f</b></span><span class="s2">'</span><span class="s7"> </span><span class="s3">%</span><span class="s7"> BO</span><span class="s3">.</span><span class="s7">res[</span><span class="s2">'max'</span><span class="s7">][</span><span class="s2">'max_val'</span><span class="s7">])</span></p>
<p class="p16"><span class="s7">C </span><span class="s3">=</span><span class="s7"> BO</span><span class="s3">.</span><span class="s7">res[</span><span class="s2">'max'</span><span class="s7">][</span><span class="s2">'max_params'</span><span class="s7">][</span><span class="s2">'C'</span><span class="s7">]</span></p>
<p class="p16"><span class="s7">w </span><span class="s3">=</span><span class="s7"> BO</span><span class="s3">.</span><span class="s7">res[</span><span class="s2">'max'</span><span class="s7">][</span><span class="s2">'max_params'</span><span class="s7">][</span><span class="s2">'w'</span><span class="s7">]</span></p>
<p class="p4"><span class="s2">lr </span><span class="s3">=</span><span class="s2"> LogisticRegression(C</span><span class="s3">=</span><span class="s2">C, class_weight</span><span class="s3">=</span><span class="s2">{</span><span class="s3">0</span><span class="s2">:</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">:w})</span></p>
<p class="p16"><span class="s9">print</span><span class="s7">(BO</span><span class="s3">.</span><span class="s7">res[</span><span class="s2">'max'</span><span class="s7">][</span><span class="s2">'max_params'</span><span class="s7">])</span></p>
<p class="p16"><span class="s7">scoring </span><span class="s3">=</span><span class="s7"> [</span><span class="s2">'roc_auc'</span><span class="s7">, </span><span class="s2">'precision'</span><span class="s7">, </span><span class="s2">'recall'</span><span class="s7">, </span><span class="s2">'f1'</span><span class="s7">]</span></p>
<p class="p4"><span class="s2">scores </span><span class="s3">=</span><span class="s2"> cross_validate(lr, data, target, scoring</span><span class="s3">=</span><span class="s2">scoring, cv</span><span class="s3">=</span><span class="s2">RepeatedStratifiedKFold(n_splits</span><span class="s3">=5</span><span class="s2">, n_repeats</span><span class="s3">=10</span><span class="s2">), return_train_score</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">)</span></p>
<p class="p16"><span class="s9">print</span><span class="s7">(</span><span class="s2">'Averages of training scores:'</span><span class="s7">)</span></p>
<p class="p16"><span class="s9">print</span><span class="s7">(</span><span class="s2">'rocauc</span><span class="s18"><b>\t</b></span><span class="s2">preci</span><span class="s18"><b>\t</b></span><span class="s2">recall</span><span class="s18"><b>\t</b></span><span class="s2">f1'</span><span class="s7">)</span></p>
<p class="p17"><span class="s9">print</span><span class="s7">(</span><span class="s10">'</span><span class="s2"><b>{roc_auc:0.2f}</b></span><span class="s18"><b>\t</b></span><span class="s2"><b>{precision:0.2f}</b></span><span class="s18"><b>\t</b></span><span class="s2"><b>{recall:0.2f}</b></span><span class="s18"><b>\t</b></span><span class="s2"><b>{f1:0.2f}</b></span><span class="s10">'</span><span class="s3">.</span><span class="s7">format(roc_auc</span><span class="s3">=</span><span class="s7">scores[</span><span class="s10">'train_roc_auc'</span><span class="s7">]</span><span class="s3">.</span><span class="s7">mean(),</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                                                                          </span>precision</span><span class="s3">=</span><span class="s2">scores[</span><span class="s10">'train_precision'</span><span class="s2">]</span><span class="s3">.</span><span class="s2">mean(),</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                                                                          </span>recall</span><span class="s3">=</span><span class="s2">scores[</span><span class="s10">'train_recall'</span><span class="s2">]</span><span class="s3">.</span><span class="s2">mean(),</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                                                                          </span>f1</span><span class="s3">=</span><span class="s2">scores[</span><span class="s10">'train_f1'</span><span class="s2">]</span><span class="s3">.</span><span class="s2">mean()))</span></p>
<p class="p16"><span class="s9">print</span><span class="s7">(</span><span class="s2">'Averages of testing scores:'</span><span class="s7">)</span></p>
<p class="p16"><span class="s9">print</span><span class="s7">(</span><span class="s2">'rocauc</span><span class="s18"><b>\t</b></span><span class="s2">preci</span><span class="s18"><b>\t</b></span><span class="s2">recall</span><span class="s18"><b>\t</b></span><span class="s2">f1'</span><span class="s7">)</span></p>
<p class="p17"><span class="s9">print</span><span class="s7">(</span><span class="s10">'</span><span class="s2"><b>{roc_auc:0.2f}</b></span><span class="s18"><b>\t</b></span><span class="s2"><b>{precision:0.2f}</b></span><span class="s18"><b>\t</b></span><span class="s2"><b>{recall:0.2f}</b></span><span class="s18"><b>\t</b></span><span class="s2"><b>{f1:0.2f}</b></span><span class="s10">'</span><span class="s3">.</span><span class="s7">format(roc_auc</span><span class="s3">=</span><span class="s7">scores[</span><span class="s10">'test_roc_auc'</span><span class="s7">]</span><span class="s3">.</span><span class="s7">mean(),</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                                                                          </span>precision</span><span class="s3">=</span><span class="s2">scores[</span><span class="s10">'test_precision'</span><span class="s2">]</span><span class="s3">.</span><span class="s2">mean(),</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                                                                          </span>recall</span><span class="s3">=</span><span class="s2">scores[</span><span class="s10">'test_recall'</span><span class="s2">]</span><span class="s3">.</span><span class="s2">mean(),</span></p>
<p class="p12"><span class="s5"><span class="Apple-converted-space">                                                                          </span>f1</span><span class="s4">=</span><span class="s5">scores[</span><span class="s12">'test_f1'</span><span class="s5">]</span><span class="s4">.</span><span class="s5">mean()))</span><span class="s13"><br>
</span></p>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Prediction on the full dataset</b></span></h2>
<p class="p6"><span class="s1">We illustrate the model performance by making predictions of the full dataset. In order to truthfully report the performance we use <a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.cross_val_predict.html"><span class="s17">"cross-validated predictions"</span></a>. Here, for each data point the prediction is obtained from a model that was fitted without using this point.</span><span class="s2"><br>
</span></p>
<p class="p4"><span class="s9"><b>from</b></span><span class="s2"> </span><span class="s8"><b>sklearn.model_selection</b></span><span class="s2"> </span><span class="s9"><b>import</b></span><span class="s2"> cross_val_predict, LeaveOneOut</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">pred_proba </span><span class="s3">=</span><span class="s2"> cross_val_predict(lr, data, target, cv</span><span class="s3">=</span><span class="s2">LeaveOneOut(), method</span><span class="s3">=</span><span class="s10">'predict_proba'</span><span class="s2">)</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">We store the outcome in a dataframe and plot both a normalized histogram and a (estimated) continuous distribution for survived and deceased separately.</span></p>
<p class="p4"><span class="s2">results </span><span class="s3">=</span><span class="s2"> pd</span><span class="s3">.</span><span class="s2">DataFrame()</span></p>
<p class="p4"><span class="s2">results[</span><span class="s10">'true'</span><span class="s2">] </span><span class="s3">=</span><span class="s2"> target</span></p>
<p class="p7"><span class="s2"><i>#results['true'] = target_selected</i></span></p>
<p class="p4"><span class="s2">results[</span><span class="s10">'pred_proba'</span><span class="s2">] </span><span class="s3">=</span><span class="s2"> pred_proba[:,</span><span class="s3">1</span><span class="s2">]</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">figure(figsize</span><span class="s3">=</span><span class="s2">(</span><span class="s3">15</span><span class="s2">,</span><span class="s3">5</span><span class="s2">))</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">title(</span><span class="s2">"Prediction probabilites survived &amp; deceased (normalized histogram)"</span><span class="s7">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">ylabel(</span><span class="s10">"Density"</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">sns</span><span class="s3">.</span><span class="s2">distplot(results[results[</span><span class="s10">'true'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> </span><span class="s3">1</span><span class="s2">][</span><span class="s10">'pred_proba'</span><span class="s2">], bins</span><span class="s3">=10</span><span class="s2">, kde</span><span class="s3">=</span><span class="s9"><b>False</b></span><span class="s2">, label</span><span class="s3">=</span><span class="s10">'deceased'</span><span class="s2">, norm_hist</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">)</span></p>
<p class="p4"><span class="s2">sns</span><span class="s3">.</span><span class="s2">distplot(results[results[</span><span class="s10">'true'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> </span><span class="s3">0</span><span class="s2">][</span><span class="s10">'pred_proba'</span><span class="s2">], bins</span><span class="s3">=10</span><span class="s2">, kde</span><span class="s3">=</span><span class="s9"><b>False</b></span><span class="s2">, label</span><span class="s3">=</span><span class="s10">'survived'</span><span class="s2">, norm_hist</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">)</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">xlabel(</span><span class="s2">"Predicted probability"</span><span class="s7">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">legend()</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">figure(figsize</span><span class="s3">=</span><span class="s2">(</span><span class="s3">15</span><span class="s2">,</span><span class="s3">5</span><span class="s2">))</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">title(</span><span class="s2">"Prediction probabilites survived &amp; deceased (kde)"</span><span class="s7">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">ylabel(</span><span class="s10">"Density"</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">sns</span><span class="s3">.</span><span class="s2">distplot(results[results[</span><span class="s10">'true'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> </span><span class="s3">1</span><span class="s2">][</span><span class="s10">'pred_proba'</span><span class="s2">], bins</span><span class="s3">=10</span><span class="s2">, hist</span><span class="s3">=</span><span class="s9"><b>False</b></span><span class="s2">, label</span><span class="s3">=</span><span class="s10">'deceased'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">sns</span><span class="s3">.</span><span class="s2">distplot(results[results[</span><span class="s10">'true'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> </span><span class="s3">0</span><span class="s2">][</span><span class="s10">'pred_proba'</span><span class="s2">], bins</span><span class="s3">=10</span><span class="s2">, hist</span><span class="s3">=</span><span class="s9"><b>False</b></span><span class="s2">, label</span><span class="s3">=</span><span class="s10">'survived'</span><span class="s2">)</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">xlabel(</span><span class="s2">"Predicted probability"</span><span class="s7">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">legend()</span></p>
<p class="p11"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">In order to make strict classifications and compute the accuracy, we set a threshold.</span></p>
<p class="p4"><span class="s2">threshold </span><span class="s3">=</span><span class="s2"> </span><span class="s3">0.5</span></p>
<p class="p12"><span class="s5">results[</span><span class="s12">'pred'</span><span class="s5">] </span><span class="s4">=</span><span class="s5"> </span><span class="s4">1</span><span class="s5"> </span><span class="s4">*</span><span class="s5"> (results[</span><span class="s12">'pred_proba'</span><span class="s5">] </span><span class="s4">&gt;</span><span class="s5"> threshold)</span><span class="s6"><br>
</span></p>
<p class="p6"><span class="s1">The misclassifications are examined below.</span></p>
<p class="p16"><span class="s7">results[results[</span><span class="s2">'true'</span><span class="s7">] </span><span class="s3">!=</span><span class="s7"> results[</span><span class="s2">'pred'</span><span class="s7">]]</span><span class="s3">.</span><span class="s7">to_csv(</span><span class="s2">'images/without_gcs/misclassifications.csv'</span><span class="s7">)</span></p>
<p class="p16"><span class="s9"><b>with</b></span><span class="s7"> pd</span><span class="s3">.</span><span class="s7">option_context(</span><span class="s2">'display.max_rows'</span><span class="s7">, </span><span class="s9"><b>None</b></span><span class="s7">, </span><span class="s2">'display.max_columns'</span><span class="s7">, </span><span class="s9"><b>None</b></span><span class="s7">):</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span></span><span class="s9">print</span><span class="s2">(results[results[</span><span class="s10">'true'</span><span class="s2">] </span><span class="s3">!=</span><span class="s2"> results[</span><span class="s10">'pred'</span><span class="s2">]])</span></p>
<p class="p4"><span class="s9"><b>from</b></span><span class="s2"> </span><span class="s8"><b>sklearn.metrics</b></span><span class="s2"> </span><span class="s9"><b>import</b></span><span class="s2"> confusion_matrix, accuracy_score</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s9">print</span><span class="s2">(</span><span class="s10">'Accuracy: </span><span class="s15"><b>{}</b></span><span class="s10">%'</span><span class="s3">.</span><span class="s2">format(np</span><span class="s3">.</span><span class="s2">round(</span><span class="s3">100</span><span class="s2"> </span><span class="s3">*</span><span class="s2"> accuracy_score(results[</span><span class="s10">'true'</span><span class="s2">], results[</span><span class="s10">'pred'</span><span class="s2">]), </span><span class="s3">2</span><span class="s2">)))</span></p>
<p class="p8"><span class="s2">print</span><span class="s7">()</span></p>
<p class="p16"><span class="s9">print</span><span class="s7">(</span><span class="s2">'Confusion matrix:'</span><span class="s7">)</span></p>
<p class="p4"><span class="s2">cm </span><span class="s3">=</span><span class="s2"> confusion_matrix(results[</span><span class="s10">'true'</span><span class="s2">], results[</span><span class="s10">'pred'</span><span class="s2">])</span></p>
<p class="p8"><span class="s2">print</span><span class="s7">(cm)</span></p>
<p class="p8"><span class="s2">print</span><span class="s7">()</span></p>
<p class="p16"><span class="s9">print</span><span class="s7">(</span><span class="s2">"False positives: </span><span class="s15"><b>{}</b></span><span class="s2">"</span><span class="s3">.</span><span class="s7">format(cm[</span><span class="s3">0</span><span class="s7">][</span><span class="s3">1</span><span class="s7">]))</span></p>
<p class="p16"><span class="s9">print</span><span class="s7">(</span><span class="s2">"False negatives: </span><span class="s15"><b>{}</b></span><span class="s2">"</span><span class="s3">.</span><span class="s7">format(cm[</span><span class="s3">1</span><span class="s7">][</span><span class="s3">0</span><span class="s7">]))</span></p>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 14.0px"><span class="s2"></span><br></h2>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Calculate features for each time window (multiprocess)</b></span></h2>
<p class="p9"><span class="s9"><b>from</b></span><span class="s7"> </span><span class="s2"><b>sklearn.preprocessing</b></span><span class="s7"> </span><span class="s9"><b>import</b></span><span class="s7"> StandardScaler</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s2"><i># Calculate features for the full dataset</i></span></p>
<p class="p4"><span class="s2">data_full, target </span><span class="s3">=</span><span class="s2"> prepare_data(df_patients, df_icp, df_map, df_cpp)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s2"><i># Scale the features</i></span></p>
<p class="p4"><span class="s2">scaler </span><span class="s3">=</span><span class="s2"> StandardScaler()</span></p>
<p class="p4"><span class="s2">data_scaled </span><span class="s3">=</span><span class="s2"> pd</span><span class="s3">.</span><span class="s2">DataFrame(data</span><span class="s3">=</span><span class="s2">scaler</span><span class="s3">.</span><span class="s2">fit_transform(data_full), index</span><span class="s3">=</span><span class="s2">data_full</span><span class="s3">.</span><span class="s2">index, columns</span><span class="s3">=</span><span class="s2">data_full</span><span class="s3">.</span><span class="s2">columns)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s2"><i># Sort indices</i></span></p>
<p class="p4"><span class="s2">data </span><span class="s3">=</span><span class="s2"> data_scaled</span><span class="s3">.</span><span class="s2">sort_index()</span></p>
<p class="p4"><span class="s2">target </span><span class="s3">=</span><span class="s2"> target</span><span class="s3">.</span><span class="s2">sort_index()</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s2"><i># Create dictionaries for the features</i></span></p>
<p class="p7"><span class="s7">data_full_pred </span><span class="s3">=</span><span class="s7"> </span><span class="s9">dict</span><span class="s7">()<span class="Apple-converted-space">  </span></span><span class="s2"><i># All the features computed from truncated time series<span class="Apple-converted-space"> </span></i></span></p>
<p class="p7"><span class="s7">data_pred </span><span class="s3">=</span><span class="s7"> </span><span class="s9">dict</span><span class="s7">()<span class="Apple-converted-space">  </span></span><span class="s2"><i># All the scaled features</i></span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p9"><span class="s9"><b>import</b></span><span class="s7"> </span><span class="s2"><b>multiprocessing</b></span><span class="s7"> </span><span class="s9"><b>as</b></span><span class="s7"> </span><span class="s2"><b>mp</b></span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">hours </span><span class="s3">=</span><span class="s2"> </span><span class="s9">range</span><span class="s2">(</span><span class="s3">24</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">8</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">manager </span><span class="s3">=</span><span class="s2"> mp</span><span class="s3">.</span><span class="s2">Manager()</span></p>
<p class="p4"><span class="s2">data_full_pred </span><span class="s3">=</span><span class="s2"> manager</span><span class="s3">.</span><span class="s2">dict()</span></p>
<p class="p4"><span class="s2">n_cores </span><span class="s3">=</span><span class="s2"> </span><span class="s3">4</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s2"><i># created pool running maximum 4 cores</i></span></p>
<p class="p4"><span class="s2">pool </span><span class="s3">=</span><span class="s2"> mp</span><span class="s3">.</span><span class="s2">Pool(n_cores)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s2"><i># Execute the feature calculation in parallel</i></span></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> hour </span><span class="s14"><b>in</b></span><span class="s2"> hours:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>pool</span><span class="s3">.</span><span class="s2">apply_async(multiprocess_prepare_data, args</span><span class="s3">=</span><span class="s2">(df_patients,<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                                                      </span>df_icp[df_icp</span><span class="s3">.</span><span class="s2">delta </span><span class="s3">&lt;</span><span class="s2"> </span><span class="s9">str</span><span class="s2">(hour) </span><span class="s3">+</span><span class="s2"> </span><span class="s10">"h"</span><span class="s2">],</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                                                      </span>df_map[df_map</span><span class="s3">.</span><span class="s2">delta </span><span class="s3">&lt;</span><span class="s2"> </span><span class="s9">str</span><span class="s2">(hour) </span><span class="s3">+</span><span class="s2"> </span><span class="s10">"h"</span><span class="s2">],</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                                                      </span>df_cpp[df_cpp</span><span class="s3">.</span><span class="s2">delta </span><span class="s3">&lt;</span><span class="s2"> </span><span class="s9">str</span><span class="s2">(hour) </span><span class="s3">+</span><span class="s2"> </span><span class="s10">"h"</span><span class="s2">],</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                                                      </span>data_full_pred,<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">                                                      </span>hour))</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p7"><span class="s2"><i># Tell the pool that there are no more tasks to come and join</i></span></p>
<p class="p4"><span class="s2">pool</span><span class="s3">.</span><span class="s2">close()</span></p>
<p class="p4"><span class="s2">pool</span><span class="s3">.</span><span class="s2">join()</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> hour </span><span class="s14"><b>in</b></span><span class="s2"> hours:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>data_pred[hour] </span><span class="s3">=</span><span class="s2"> pd</span><span class="s3">.</span><span class="s2">DataFrame(data</span><span class="s3">=</span><span class="s2">scaler</span><span class="s3">.</span><span class="s2">transform(data_full_pred[hour]), index</span><span class="s3">=</span><span class="s2">data_full_pred[hour]</span><span class="s3">.</span><span class="s2">index, columns</span><span class="s3">=</span><span class="s2">data_full_pred[hour]</span><span class="s3">.</span><span class="s2">columns)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>data_pred[hour] </span><span class="s3">=</span><span class="s2"> data_pred[hour]</span><span class="s3">.</span><span class="s2">sort_index()</span></p>
<h1 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 14.0px"><span class="s2"></span><br></h1>
<h1 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Calculate cross-validated AUC-ROC</b></span></h1>
<p class="p4"><span class="s9"><b>from</b></span><span class="s2"> </span><span class="s8"><b>sklearn.model_selection</b></span><span class="s2"> </span><span class="s9"><b>import</b></span><span class="s2"> KFold, StratifiedKFold, RepeatedStratifiedKFold</span></p>
<p class="p4"><span class="s9"><b>from</b></span><span class="s2"> </span><span class="s8"><b>sklearn.metrics</b></span><span class="s2"> </span><span class="s9"><b>import</b></span><span class="s2"> roc_curve, auc, roc_auc_score</span></p>
<p class="p8"><span class="s2"><b>from</b></span><span class="s7"> </span><span class="s8"><b>scipy</b></span><span class="s7"> </span><span class="s2"><b>import</b></span><span class="s7"> interp</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">fold_method </span><span class="s3">=</span><span class="s2"> RepeatedStratifiedKFold(n_splits</span><span class="s3">=5</span><span class="s2">, n_repeats</span><span class="s3">=20</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">lr_model </span><span class="s3">=</span><span class="s2"> LogisticRegression(C</span><span class="s3">=</span><span class="s2">C, class_weight</span><span class="s3">=</span><span class="s2">{</span><span class="s3">0</span><span class="s2">:</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">:w})</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">aucs_train </span><span class="s3">=</span><span class="s2"> </span><span class="s9">dict</span><span class="s2">()</span></p>
<p class="p4"><span class="s2">aucs_test </span><span class="s3">=</span><span class="s2"> </span><span class="s9">dict</span><span class="s2">()</span></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> hours </span><span class="s14"><b>in</b></span><span class="s2"> </span><span class="s9">range</span><span class="s2">(</span><span class="s3">24</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">8</span><span class="s2">):</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>aucs_train[hours] </span><span class="s3">=</span><span class="s2"> </span><span class="s9">list</span><span class="s2">()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>aucs_test[hours] </span><span class="s3">=</span><span class="s2"> </span><span class="s9">list</span><span class="s2">()</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">selected_columns </span><span class="s3">=</span><span class="s2"> data</span><span class="s3">.</span><span class="s2">columns[rfecv</span><span class="s3">.</span><span class="s2">support_]</span></p>
<p class="p4"><span class="s2">data </span><span class="s3">=</span><span class="s2"> data[selected_columns]</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> train_indices, test_indices </span><span class="s14"><b>in</b></span><span class="s2"> fold_method</span><span class="s3">.</span><span class="s2">split(data, target):</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># train_indices and test_indices are positional indices, transforming them to patient_ids:</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>train_patients, test_patients </span><span class="s3">=</span><span class="s2"> data</span><span class="s3">.</span><span class="s2">index[train_indices], data</span><span class="s3">.</span><span class="s2">index[test_indices]</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># Train the fold specific model with full time series</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>classifier </span><span class="s3">=</span><span class="s2"> lr_model</span><span class="s3">.</span><span class="s2">fit(data</span><span class="s3">.</span><span class="s2">loc[train_patients], target</span><span class="s3">.</span><span class="s2">loc[train_patients])</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">  </span></span><span class="s2"><i># Calculate metrics for each time window</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>for</b></span><span class="s2"> hours </span><span class="s14"><b>in</b></span><span class="s2"> </span><span class="s9">range</span><span class="s2">(</span><span class="s3">24</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">8</span><span class="s2">):</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>preds_train </span><span class="s3">=</span><span class="s2"> classifier</span><span class="s3">.</span><span class="s2">predict_proba(data_pred[hours][selected_columns]</span><span class="s3">.</span><span class="s2">loc[train_patients])[:,</span><span class="s3">1</span><span class="s2">]</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>preds_test </span><span class="s3">=</span><span class="s2"> classifier</span><span class="s3">.</span><span class="s2">predict_proba(data_pred[hours][selected_columns]</span><span class="s3">.</span><span class="s2">loc[test_patients])[:,</span><span class="s3">1</span><span class="s2">]</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">    </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>score_train </span><span class="s3">=</span><span class="s2"> roc_auc_score(target</span><span class="s3">.</span><span class="s2">loc[train_patients], preds_train)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>score_test </span><span class="s3">=</span><span class="s2"> roc_auc_score(target</span><span class="s3">.</span><span class="s2">loc[test_patients], preds_test)</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">    </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>aucs_train[hours]</span><span class="s3">.</span><span class="s2">append(score_train)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>aucs_test[hours]</span><span class="s3">.</span><span class="s2">append(score_test)</span></p>
<h1 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 14.0px"><span class="s2"></span><br></h1>
<h1 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Calculate hourly AUC means, AUC standard deviations and plot hourly AUCs with their error estimates</b></span></h1>
<p class="p9"><span class="s9"><b>def</b></span><span class="s7"> </span><span class="s2">auc_stats</span><span class="s7">(aucs):</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>aucs_mean </span><span class="s3">=</span><span class="s2"> []</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>aucs_std </span><span class="s3">=</span><span class="s2"> []</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>aucs_lower </span><span class="s3">=</span><span class="s2"> []</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>aucs_upper </span><span class="s3">=</span><span class="s2"> []</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>for</b></span><span class="s2"> hours </span><span class="s14"><b>in</b></span><span class="s2"> </span><span class="s9">range</span><span class="s2">(</span><span class="s3">24</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">8</span><span class="s2">):</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>mean </span><span class="s3">=</span><span class="s2"> np</span><span class="s3">.</span><span class="s2">mean(aucs[hours])</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>aucs_mean</span><span class="s3">.</span><span class="s2">append(mean)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>std </span><span class="s3">=</span><span class="s2"> np</span><span class="s3">.</span><span class="s2">std(aucs[hours])</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>aucs_std</span><span class="s3">.</span><span class="s2">append(std)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>lower </span><span class="s3">=</span><span class="s2"> mean </span><span class="s3">-</span><span class="s2"> std</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>aucs_lower</span><span class="s3">.</span><span class="s2">append(lower)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>upper </span><span class="s3">=</span><span class="s2"> mean </span><span class="s3">+</span><span class="s2"> std</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>aucs_upper</span><span class="s3">.</span><span class="s2">append(upper)</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">    </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>return</b></span><span class="s2"> aucs_mean, aucs_lower, aucs_upper</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">aucs_train_mean, aucs_train_lower, aucs_train_upper </span><span class="s3">=</span><span class="s2"> auc_stats(aucs_train)</span></p>
<p class="p4"><span class="s2">aucs_test_mean, aucs_test_lower, aucs_test_upper </span><span class="s3">=</span><span class="s2"> auc_stats(aucs_test)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">time </span><span class="s3">=</span><span class="s2"> </span><span class="s9">range</span><span class="s2">(</span><span class="s3">24</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">8</span><span class="s2">)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">figure(figsize</span><span class="s3">=</span><span class="s2">(</span><span class="s3">16</span><span class="s2">,</span><span class="s3">12</span><span class="s2">))</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">plot(time, aucs_train_mean, color</span><span class="s3">=</span><span class="s10">'black'</span><span class="s2">, linestyle</span><span class="s3">=</span><span class="s10">'--'</span><span class="s2">, label</span><span class="s3">=</span><span class="s10">r'AUROC $\pm$ 1 std. dev. (train)'</span><span class="s2">)</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">plot(time, aucs_test_mean, color</span><span class="s3">=</span><span class="s2">'red'</span><span class="s7">, label</span><span class="s3">=</span><span class="s2">r'AUROC $\pm$ 1 std. dev. (validation)'</span><span class="s7">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">fill_between(time, aucs_train_lower, aucs_train_upper, color</span><span class="s3">=</span><span class="s10">'black'</span><span class="s2">, alpha</span><span class="s3">=.2</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">fill_between(time, aucs_test_lower, aucs_test_upper, color</span><span class="s3">=</span><span class="s10">'red'</span><span class="s2">, alpha</span><span class="s3">=.1</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">xlabel(</span><span class="s10">'Time (h)'</span><span class="s2">)</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">ylabel(</span><span class="s2">'Area under ROC'</span><span class="s7">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">legend(loc</span><span class="s3">=</span><span class="s10">'upper right'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">ylim((</span><span class="s3">0.6</span><span class="s2">,</span><span class="s3">1.0</span><span class="s2">))</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">savefig(</span><span class="s2">'images/without_gcs/auc_roc.png'</span><span class="s7">)</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">show()</span></p>
<h4 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 14.0px"><span class="s2"></span><br></h4>
<h4 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff"><span class="s2"><b>View the predictions dynamically</b></span></h4>
<p class="p14"><span class="s2">One of the central requirements for our model was to have it predict dynamically, i.e. to make it sensitive to changes in the ICP-MAP measurements for each patient. The features facilitating this are naturally the final 8h means of each derived series as well as their linear trend coefficients. Below we illustrate this by rolling out the monitor data in 8 hour windows and predicting as we go.</span></p>
<p class="p15"><span class="s2"></span><br></p>
<p class="p6"><span class="s1">Notice that the model is fit on the full dataset of untruncated time series. While the rolled out monitor data is in principle unseen to the model, some features such as the initial 24h means do not change. One should therefore view this primarily as an illustration and not a test.</span><span class="s2"><br>
</span></p>
<p class="p14"><span class="s2">Computing the features for each 8h step takes a few minutes.</span></p>
<p class="p15"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">lr </span><span class="s3">=</span><span class="s2"> LogisticRegression(C</span><span class="s3">=</span><span class="s2">C, class_weight</span><span class="s3">=</span><span class="s2">{</span><span class="s3">0</span><span class="s2">:</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">:w})</span></p>
<p class="p4"><span class="s2">lr</span><span class="s3">.</span><span class="s2">fit(data[selected_columns], target)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">predict_proba </span><span class="s3">=</span><span class="s2"> </span><span class="s9">dict</span><span class="s2">()</span></p>
<p class="p7"><span class="s7">all_proba </span><span class="s3">=</span><span class="s7"> pd</span><span class="s3">.</span><span class="s7">DataFrame() </span><span class="s2"><i># a dataframe for the predictions</i></span></p>
<p class="p4"><span class="s2">all_proba[</span><span class="s10">'true'</span><span class="s2">] </span><span class="s3">=</span><span class="s2"> target</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> hours </span><span class="s14"><b>in</b></span><span class="s2"> tqdm_notebook(</span><span class="s9">range</span><span class="s2">(</span><span class="s3">24</span><span class="s2">, </span><span class="s3">128</span><span class="s2">, </span><span class="s3">8</span><span class="s2">), ncols</span><span class="s3">=1000</span><span class="s2">, desc</span><span class="s3">=</span><span class="s10">"Hours"</span><span class="s2">):</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>predict_proba[hours] </span><span class="s3">=</span><span class="s2"> lr</span><span class="s3">.</span><span class="s2">predict_proba(data_pred[hours][selected_columns])[:,</span><span class="s3">1</span><span class="s2">] </span><span class="s16"><i># the slicing chooses the probability of death for each patient</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>pred </span><span class="s3">=</span><span class="s2"> pd</span><span class="s3">.</span><span class="s2">DataFrame(predict_proba[hours], index</span><span class="s3">=</span><span class="s2">data_pred[hours]</span><span class="s3">.</span><span class="s2">index)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>all_proba[hours] </span><span class="s3">=</span><span class="s2"> pred</span></p>
<p class="p4"><span class="s2">proba_dead </span><span class="s3">=</span><span class="s2"> all_proba[all_proba</span><span class="s3">.</span><span class="s2">true </span><span class="s3">==</span><span class="s2"> </span><span class="s3">1</span><span class="s2">]</span><span class="s3">.</span><span class="s2">drop(columns</span><span class="s3">=</span><span class="s10">'true'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">transpose()</span><span class="s3">.</span><span class="s2">sort_index()</span></p>
<p class="p4"><span class="s2">proba_alive </span><span class="s3">=</span><span class="s2"> all_proba[all_proba</span><span class="s3">.</span><span class="s2">true </span><span class="s3">==</span><span class="s2"> </span><span class="s3">0</span><span class="s2">]</span><span class="s3">.</span><span class="s2">drop(columns</span><span class="s3">=</span><span class="s10">'true'</span><span class="s2">)</span><span class="s3">.</span><span class="s2">transpose()</span><span class="s3">.</span><span class="s2">sort_index()</span></p>
<p class="p4"><span class="s2">df_icp[</span><span class="s10">'hours'</span><span class="s2">] </span><span class="s3">=</span><span class="s2"> df_icp[</span><span class="s10">'delta'</span><span class="s2">]</span><span class="s3">.</span><span class="s2">map(</span><span class="s9"><b>lambda</b></span><span class="s2"> x: x</span><span class="s3">.</span><span class="s2">total_seconds() </span><span class="s3">/</span><span class="s2"> </span><span class="s3">60</span><span class="s2"> </span><span class="s3">/</span><span class="s2"> </span><span class="s3">60</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">df_map[</span><span class="s10">'hours'</span><span class="s2">] </span><span class="s3">=</span><span class="s2"> df_map[</span><span class="s10">'delta'</span><span class="s2">]</span><span class="s3">.</span><span class="s2">map(</span><span class="s9"><b>lambda</b></span><span class="s2"> x: x</span><span class="s3">.</span><span class="s2">total_seconds() </span><span class="s3">/</span><span class="s2"> </span><span class="s3">60</span><span class="s2"> </span><span class="s3">/</span><span class="s2"> </span><span class="s3">60</span><span class="s2">)</span></p>
<p class="p12"><span class="s5">df_cpp[</span><span class="s12">'hours'</span><span class="s5">] </span><span class="s4">=</span><span class="s5"> df_cpp[</span><span class="s12">'delta'</span><span class="s5">]</span><span class="s4">.</span><span class="s5">map(</span><span class="s11"><b>lambda</b></span><span class="s5"> x: x</span><span class="s4">.</span><span class="s5">total_seconds() </span><span class="s4">/</span><span class="s5"> </span><span class="s4">60</span><span class="s5"> </span><span class="s4">/</span><span class="s5"> </span><span class="s4">60</span><span class="s5">)</span><span class="s6"><br>
</span></p>
<p class="p6"><span class="s1">It is interesting to view how the predictions evolve for patients who deceased. We plot the predictions on top of their ICP-MAP-CPP data.</span></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> i </span><span class="s14"><b>in</b></span><span class="s2"> proba_dead</span><span class="s3">.</span><span class="s2">columns: <span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>fig, ax1 </span><span class="s3">=</span><span class="s2"> plt</span><span class="s3">.</span><span class="s2">subplots()</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>fig</span><span class="s3">.</span><span class="s2">set_size_inches(</span><span class="s3">25</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">title(</span><span class="s10">'Patient </span><span class="s15"><b>{}</b></span><span class="s10"> deceased'</span><span class="s3">.</span><span class="s2">format(i))</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s7">xlabel(</span><span class="s2">"Time passed (hours)"</span><span class="s7">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>p0, </span><span class="s3">=</span><span class="s2"> ax1</span><span class="s3">.</span><span class="s2">plot((proba_dead</span><span class="s3">.</span><span class="s2">index), proba_dead[i], label</span><span class="s3">=</span><span class="s10">"estimate"</span><span class="s2">, color</span><span class="s3">=</span><span class="s10">'red'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax1</span><span class="s3">.</span><span class="s2">set_ylim([</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1.01</span><span class="s2">])</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax1</span><span class="s3">.</span><span class="s2">set_ylabel(</span><span class="s10">'Estimate'</span><span class="s2">, fontsize</span><span class="s3">=12</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax1</span><span class="s3">.</span><span class="s2">tick_params(</span><span class="s10">'y'</span><span class="s2">, colors</span><span class="s3">=</span><span class="s10">'red'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax1</span><span class="s3">.</span><span class="s2">grid(visible</span><span class="s3">=</span><span class="s9"><b>False</b></span><span class="s2">)</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax2 </span><span class="s3">=</span><span class="s2"> ax1</span><span class="s3">.</span><span class="s2">twinx()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>p1, </span><span class="s3">=</span><span class="s2"> ax2</span><span class="s3">.</span><span class="s2">plot(df_icp[df_icp</span><span class="s3">.</span><span class="s2">id </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">hours, df_icp[df_icp</span><span class="s3">.</span><span class="s2">id </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">value, label</span><span class="s3">=</span><span class="s10">'icp'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>p2, </span><span class="s3">=</span><span class="s2"> ax2</span><span class="s3">.</span><span class="s2">plot(df_map[df_map</span><span class="s3">.</span><span class="s2">id </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">hours, df_map[df_map</span><span class="s3">.</span><span class="s2">id </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">value, label</span><span class="s3">=</span><span class="s10">'map'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>p3, </span><span class="s3">=</span><span class="s2"> ax2</span><span class="s3">.</span><span class="s2">plot(df_cpp[df_cpp</span><span class="s3">.</span><span class="s2">id </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">hours, df_cpp[df_cpp</span><span class="s3">.</span><span class="s2">id </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">value, label</span><span class="s3">=</span><span class="s10">'cpp'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax2</span><span class="s3">.</span><span class="s2">set_ylim([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">150</span><span class="s2">])</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax2</span><span class="s3">.</span><span class="s2">set_ylabel(</span><span class="s10">'mmHg'</span><span class="s2">, fontsize</span><span class="s3">=12</span><span class="s2">)</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>lines </span><span class="s3">=</span><span class="s2"> [p0, p1, p2, p3]</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax2</span><span class="s3">.</span><span class="s2">legend(lines, [l</span><span class="s3">.</span><span class="s2">get_label() </span><span class="s9"><b>for</b></span><span class="s2"> l </span><span class="s14"><b>in</b></span><span class="s2"> lines], loc</span><span class="s3">=2</span><span class="s2">)</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>fig</span><span class="s3">.</span><span class="s2">tight_layout()</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span>fig</span><span class="s3">.</span><span class="s7">savefig(</span><span class="s2">'images/without_gcs/deceased/'</span><span class="s7"> </span><span class="s3">+</span><span class="s7"> </span><span class="s9">str</span><span class="s7">(i) </span><span class="s3">+</span><span class="s7"> </span><span class="s2">'_timeseries.png'</span><span class="s7">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">close()</span></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> i </span><span class="s14"><b>in</b></span><span class="s2"> proba_alive</span><span class="s3">.</span><span class="s2">columns: <span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>fig, ax1 </span><span class="s3">=</span><span class="s2"> plt</span><span class="s3">.</span><span class="s2">subplots()</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>fig</span><span class="s3">.</span><span class="s2">set_size_inches(</span><span class="s3">25</span><span class="s2">, </span><span class="s3">5</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">title(</span><span class="s10">'Patient </span><span class="s15"><b>{}</b></span><span class="s10"> survived'</span><span class="s3">.</span><span class="s2">format(i))</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s7">xlabel(</span><span class="s2">"Time passed (hours)"</span><span class="s7">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>p0, </span><span class="s3">=</span><span class="s2"> ax1</span><span class="s3">.</span><span class="s2">plot((proba_alive</span><span class="s3">.</span><span class="s2">index), proba_alive[i], label</span><span class="s3">=</span><span class="s10">"estimate"</span><span class="s2">, color</span><span class="s3">=</span><span class="s10">'red'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax1</span><span class="s3">.</span><span class="s2">set_ylim([</span><span class="s3">0</span><span class="s2">,</span><span class="s3">1.01</span><span class="s2">])</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax1</span><span class="s3">.</span><span class="s2">set_ylabel(</span><span class="s10">'Estimate'</span><span class="s2">, fontsize</span><span class="s3">=12</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax1</span><span class="s3">.</span><span class="s2">tick_params(</span><span class="s10">'y'</span><span class="s2">, colors</span><span class="s3">=</span><span class="s10">'red'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax1</span><span class="s3">.</span><span class="s2">grid(visible</span><span class="s3">=</span><span class="s9"><b>False</b></span><span class="s2">)</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax2 </span><span class="s3">=</span><span class="s2"> ax1</span><span class="s3">.</span><span class="s2">twinx()</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>p1, </span><span class="s3">=</span><span class="s2"> ax2</span><span class="s3">.</span><span class="s2">plot(df_icp[df_icp</span><span class="s3">.</span><span class="s2">id </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">hours, df_icp[df_icp</span><span class="s3">.</span><span class="s2">id </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">value, label</span><span class="s3">=</span><span class="s10">'icp'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>p2, </span><span class="s3">=</span><span class="s2"> ax2</span><span class="s3">.</span><span class="s2">plot(df_map[df_map</span><span class="s3">.</span><span class="s2">id </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">hours, df_map[df_map</span><span class="s3">.</span><span class="s2">id </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">value, label</span><span class="s3">=</span><span class="s10">'map'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>p3, </span><span class="s3">=</span><span class="s2"> ax2</span><span class="s3">.</span><span class="s2">plot(df_cpp[df_cpp</span><span class="s3">.</span><span class="s2">id </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">hours, df_cpp[df_cpp</span><span class="s3">.</span><span class="s2">id </span><span class="s3">==</span><span class="s2"> i]</span><span class="s3">.</span><span class="s2">value, label</span><span class="s3">=</span><span class="s10">'cpp'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax2</span><span class="s3">.</span><span class="s2">set_ylim([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">150</span><span class="s2">])</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax2</span><span class="s3">.</span><span class="s2">set_ylabel(</span><span class="s10">'mmHg'</span><span class="s2">, fontsize</span><span class="s3">=12</span><span class="s2">)</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>lines </span><span class="s3">=</span><span class="s2"> [p0, p1, p2, p3]</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>ax2</span><span class="s3">.</span><span class="s2">legend(lines, [l</span><span class="s3">.</span><span class="s2">get_label() </span><span class="s9"><b>for</b></span><span class="s2"> l </span><span class="s14"><b>in</b></span><span class="s2"> lines], loc</span><span class="s3">=2</span><span class="s2">)</span></p>
<p class="p10"><span class="s2"><span class="Apple-converted-space">  </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>fig</span><span class="s3">.</span><span class="s2">tight_layout()</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span>fig</span><span class="s3">.</span><span class="s7">savefig(</span><span class="s2">'images/without_gcs/survived/'</span><span class="s7"> </span><span class="s3">+</span><span class="s7"> </span><span class="s9">str</span><span class="s7">(i) </span><span class="s3">+</span><span class="s7"> </span><span class="s2">'_timeseries.png'</span><span class="s7">)</span></p>
<p class="p12"><span class="s5"><span class="Apple-converted-space">  </span>plt</span><span class="s4">.</span><span class="s5">close()<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span><span class="s6"><br>
</span></p>
<p class="p6"><span class="s1">Let's take a closer look at our model.</span></p>
<p class="p4"><span class="s9"><b>from</b></span><span class="s2"> </span><span class="s8"><b>matplotlib.ticker</b></span><span class="s2"> </span><span class="s9"><b>import</b></span><span class="s2"> FixedFormatter</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">i </span><span class="s3">=</span><span class="s2"> np</span><span class="s3">.</span><span class="s2">random</span><span class="s3">.</span><span class="s2">choice(proba_dead</span><span class="s3">.</span><span class="s2">columns)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">importance_dict </span><span class="s3">=</span><span class="s2"> {}</span></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> hour </span><span class="s14"><b>in</b></span><span class="s2"> proba_dead</span><span class="s3">.</span><span class="s2">index:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>importance_dict[hour] </span><span class="s3">=</span><span class="s2"> data_pred[hour][selected_columns]</span><span class="s3">.</span><span class="s2">loc[i] </span><span class="s3">*</span><span class="s2"> lr</span><span class="s3">.</span><span class="s2">coef_[</span><span class="s3">0</span><span class="s2">]</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">figure(figsize</span><span class="s3">=</span><span class="s2">(</span><span class="s3">25</span><span class="s2">,</span><span class="s3">5</span><span class="s2">))</span></p>
<p class="p4"><span class="s2">sns</span><span class="s3">.</span><span class="s2">heatmap(np</span><span class="s3">.</span><span class="s2">array([importance_dict[hour] </span><span class="s9"><b>for</b></span><span class="s2"> hour </span><span class="s14"><b>in</b></span><span class="s2"> proba_dead</span><span class="s3">.</span><span class="s2">index])</span><span class="s3">.</span><span class="s2">T,<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span>linewidth</span><span class="s3">=0.1</span><span class="s2">,</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span>cmap</span><span class="s3">=</span><span class="s2">sns</span><span class="s3">.</span><span class="s2">color_palette(</span><span class="s10">"coolwarm"</span><span class="s2">, </span><span class="s3">6</span><span class="s2">),</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">            </span></span><span class="s2"><i>#cmap=sns.cubehelix_palette(n_colors=6, as_cmap=False),</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">            </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-0.82,-0.5,-0.16,0.16,0.5,0.82], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">            </span></span><span class="s2"><i>#vmin=-1, vmax=1,</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">            </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-1.65,-1.0,-0.35,0.35,1.0,1.65], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">            </span></span><span class="s2"><i>#vmin=-2, vmax=2,</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">            </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-1.65,-1.0,-0.35,0.35,1.0,1.65], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">            </span></span><span class="s2"><i>#vmin=-2, vmax=2,</i></span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">            </span>cbar_kws</span><span class="s3">=</span><span class="s7">{</span><span class="s2">'label'</span><span class="s7">: </span><span class="s2">'indication'</span><span class="s7">, </span><span class="s2">'ticks'</span><span class="s7">: [</span><span class="s3">-2.5</span><span class="s7">,</span><span class="s3">-1.5</span><span class="s7">,</span><span class="s3">-0.5</span><span class="s7">,</span><span class="s3">0.5</span><span class="s7">,</span><span class="s3">1.5</span><span class="s7">,</span><span class="s3">2.5</span><span class="s7">], </span><span class="s2">'format'</span><span class="s7">: FixedFormatter([</span><span class="s2">'extremely good'</span><span class="s7">,</span><span class="s2">'good'</span><span class="s7">,</span><span class="s2">'slightly good'</span><span class="s7">,</span><span class="s2">'slightly bad'</span><span class="s7">,</span><span class="s2">'bad'</span><span class="s7">,</span><span class="s2">'extremely bad'</span><span class="s7">])},</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span>vmin</span><span class="s3">=-3</span><span class="s2">, vmax</span><span class="s3">=3</span><span class="s2">,</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">            </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-3.3,-2.0,-0.7,0.7,2.0,3.3], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">            </span></span><span class="s2"><i>#vmin=-4, vmax=4,</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">            </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-4.1,-2.5,-0.8,0.8,2.5,4.1], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">            </span></span><span class="s2"><i>#vmin=-5, vmax=5,</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span>xticklabels</span><span class="s3">=</span><span class="s2">[</span><span class="s9">str</span><span class="s2">(hour) </span><span class="s3">+</span><span class="s2"> </span><span class="s10">': '</span><span class="s2"> </span><span class="s3">+</span><span class="s2"> </span><span class="s9">str</span><span class="s2">(</span><span class="s9">int</span><span class="s2">(np</span><span class="s3">.</span><span class="s2">rint(</span><span class="s3">100</span><span class="s2"> </span><span class="s3">*</span><span class="s2"> proba_dead[i][hour]))) </span><span class="s3">+</span><span class="s2"> </span><span class="s10">'%'</span><span class="s2"> </span><span class="s9"><b>for</b></span><span class="s2"> hour </span><span class="s14"><b>in</b></span><span class="s2"> proba_dead</span><span class="s3">.</span><span class="s2">index],</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span>yticklabels</span><span class="s3">=</span><span class="s2">importance_dict[</span><span class="s3">24</span><span class="s2">]</span><span class="s3">.</span><span class="s2">keys())</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">title(</span><span class="s10">'Patient </span><span class="s15"><b>{}</b></span><span class="s10"> deceased'</span><span class="s3">.</span><span class="s2">format(i))</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">xlabel(</span><span class="s2">'Time passed (hours): Estimated probability of death'</span><span class="s7">)</span></p>
<p class="p4"><span class="s9"><b>from</b></span><span class="s2"> </span><span class="s8"><b>matplotlib.ticker</b></span><span class="s2"> </span><span class="s9"><b>import</b></span><span class="s2"> FixedFormatter</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> i </span><span class="s14"><b>in</b></span><span class="s2"> proba_dead</span><span class="s3">.</span><span class="s2">columns:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>importance_dict </span><span class="s3">=</span><span class="s2"> {}</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>for</b></span><span class="s2"> hour </span><span class="s14"><b>in</b></span><span class="s2"> proba_dead</span><span class="s3">.</span><span class="s2">index:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>importance_dict[hour] </span><span class="s3">=</span><span class="s2"> data_pred[hour][selected_columns]</span><span class="s3">.</span><span class="s2">loc[i] </span><span class="s3">*</span><span class="s2"> lr</span><span class="s3">.</span><span class="s2">coef_[</span><span class="s3">0</span><span class="s2">]</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">figure(figsize</span><span class="s3">=</span><span class="s2">(</span><span class="s3">25</span><span class="s2">,</span><span class="s3">5</span><span class="s2">))</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>sns</span><span class="s3">.</span><span class="s2">heatmap(np</span><span class="s3">.</span><span class="s2">array([importance_dict[hour] </span><span class="s9"><b>for</b></span><span class="s2"> hour </span><span class="s14"><b>in</b></span><span class="s2"> proba_dead</span><span class="s3">.</span><span class="s2">index])</span><span class="s3">.</span><span class="s2">T,<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">              </span>linewidth</span><span class="s3">=0.1</span><span class="s2">,</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">              </span>cmap</span><span class="s3">=</span><span class="s2">sns</span><span class="s3">.</span><span class="s2">color_palette(</span><span class="s10">"coolwarm"</span><span class="s2">, </span><span class="s3">6</span><span class="s2">),</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#cmap=sns.cubehelix_palette(n_colors=6, as_cmap=False),</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-0.82,-0.5,-0.16,0.16,0.5,0.82], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#vmin=-1, vmax=1,</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-1.65,-1.0,-0.35,0.35,1.0,1.65], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#vmin=-2, vmax=2,</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-1.65,-1.0,-0.35,0.35,1.0,1.65], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#vmin=-2, vmax=2,</i></span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">              </span>cbar_kws</span><span class="s3">=</span><span class="s7">{</span><span class="s2">'label'</span><span class="s7">: </span><span class="s2">'indication'</span><span class="s7">, </span><span class="s2">'ticks'</span><span class="s7">: [</span><span class="s3">-2.5</span><span class="s7">,</span><span class="s3">-1.5</span><span class="s7">,</span><span class="s3">-0.5</span><span class="s7">,</span><span class="s3">0.5</span><span class="s7">,</span><span class="s3">1.5</span><span class="s7">,</span><span class="s3">2.5</span><span class="s7">], </span><span class="s2">'format'</span><span class="s7">: FixedFormatter([</span><span class="s2">'extremely good'</span><span class="s7">,</span><span class="s2">'good'</span><span class="s7">,</span><span class="s2">'slightly good'</span><span class="s7">,</span><span class="s2">'slightly bad'</span><span class="s7">,</span><span class="s2">'bad'</span><span class="s7">,</span><span class="s2">'extremely bad'</span><span class="s7">])},</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">              </span>vmin</span><span class="s3">=-3</span><span class="s2">, vmax</span><span class="s3">=3</span><span class="s2">,</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-3.3,-2.0,-0.7,0.7,2.0,3.3], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#vmin=-4, vmax=4,</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-4.1,-2.5,-0.8,0.8,2.5,4.1], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#vmin=-5, vmax=5,</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">              </span>xticklabels</span><span class="s3">=</span><span class="s2">[</span><span class="s9">str</span><span class="s2">(hour) </span><span class="s3">+</span><span class="s2"> </span><span class="s10">': '</span><span class="s2"> </span><span class="s3">+</span><span class="s2"> </span><span class="s9">str</span><span class="s2">(</span><span class="s9">int</span><span class="s2">(np</span><span class="s3">.</span><span class="s2">rint(</span><span class="s3">100</span><span class="s2"> </span><span class="s3">*</span><span class="s2"> proba_dead[i][hour]))) </span><span class="s3">+</span><span class="s2"> </span><span class="s10">'%'</span><span class="s2"> </span><span class="s9"><b>for</b></span><span class="s2"> hour </span><span class="s14"><b>in</b></span><span class="s2"> proba_dead</span><span class="s3">.</span><span class="s2">index],</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">              </span>yticklabels</span><span class="s3">=</span><span class="s2">importance_dict[</span><span class="s3">24</span><span class="s2">]</span><span class="s3">.</span><span class="s2">keys())</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">title(</span><span class="s10">'Patient </span><span class="s15"><b>{}</b></span><span class="s10"> deceased'</span><span class="s3">.</span><span class="s2">format(i))</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s7">xlabel(</span><span class="s2">'Time passed (hours): Estimated probability of death'</span><span class="s7">)</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s7">savefig(</span><span class="s2">'images/without_gcs/deceased/'</span><span class="s7"> </span><span class="s3">+</span><span class="s7"> </span><span class="s9">str</span><span class="s7">(i) </span><span class="s3">+</span><span class="s7"> </span><span class="s2">'_featureimportance.png'</span><span class="s7">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">close()</span></p>
<p class="p4"><span class="s9"><b>from</b></span><span class="s2"> </span><span class="s8"><b>matplotlib.ticker</b></span><span class="s2"> </span><span class="s9"><b>import</b></span><span class="s2"> FixedFormatter</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s9"><b>for</b></span><span class="s2"> i </span><span class="s14"><b>in</b></span><span class="s2"> proba_alive</span><span class="s3">.</span><span class="s2">columns:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>importance_dict </span><span class="s3">=</span><span class="s2"> {}</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span></span><span class="s9"><b>for</b></span><span class="s2"> hour </span><span class="s14"><b>in</b></span><span class="s2"> proba_alive</span><span class="s3">.</span><span class="s2">index:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">    </span>importance_dict[hour] </span><span class="s3">=</span><span class="s2"> data_pred[hour][selected_columns]</span><span class="s3">.</span><span class="s2">loc[i] </span><span class="s3">*</span><span class="s2"> lr</span><span class="s3">.</span><span class="s2">coef_[</span><span class="s3">0</span><span class="s2">]</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">figure(figsize</span><span class="s3">=</span><span class="s2">(</span><span class="s3">25</span><span class="s2">,</span><span class="s3">5</span><span class="s2">))</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>sns</span><span class="s3">.</span><span class="s2">heatmap(np</span><span class="s3">.</span><span class="s2">array([importance_dict[hour] </span><span class="s9"><b>for</b></span><span class="s2"> hour </span><span class="s14"><b>in</b></span><span class="s2"> proba_alive</span><span class="s3">.</span><span class="s2">index])</span><span class="s3">.</span><span class="s2">T,<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">              </span>linewidth</span><span class="s3">=0.1</span><span class="s2">,</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">              </span>cmap</span><span class="s3">=</span><span class="s2">sns</span><span class="s3">.</span><span class="s2">color_palette(</span><span class="s10">"coolwarm"</span><span class="s2">, </span><span class="s3">6</span><span class="s2">),</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#cmap=sns.cubehelix_palette(n_colors=6, as_cmap=False),</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-0.82,-0.5,-0.16,0.16,0.5,0.82], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#vmin=-1, vmax=1,</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-1.65,-1.0,-0.35,0.35,1.0,1.65], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#vmin=-2, vmax=2,</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-1.65,-1.0,-0.35,0.35,1.0,1.65], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#vmin=-2, vmax=2,</i></span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">              </span>cbar_kws</span><span class="s3">=</span><span class="s7">{</span><span class="s2">'label'</span><span class="s7">: </span><span class="s2">'indication'</span><span class="s7">, </span><span class="s2">'ticks'</span><span class="s7">: [</span><span class="s3">-2.5</span><span class="s7">,</span><span class="s3">-1.5</span><span class="s7">,</span><span class="s3">-0.5</span><span class="s7">,</span><span class="s3">0.5</span><span class="s7">,</span><span class="s3">1.5</span><span class="s7">,</span><span class="s3">2.5</span><span class="s7">], </span><span class="s2">'format'</span><span class="s7">: FixedFormatter([</span><span class="s2">'extremely good'</span><span class="s7">,</span><span class="s2">'good'</span><span class="s7">,</span><span class="s2">'slightly good'</span><span class="s7">,</span><span class="s2">'slightly bad'</span><span class="s7">,</span><span class="s2">'bad'</span><span class="s7">,</span><span class="s2">'extremely bad'</span><span class="s7">])},</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">              </span>vmin</span><span class="s3">=-3</span><span class="s2">, vmax</span><span class="s3">=3</span><span class="s2">,</span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-3.3,-2.0,-0.7,0.7,2.0,3.3], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#vmin=-4, vmax=4,</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#cbar_kws={'label': 'indication', 'ticks': [-4.1,-2.5,-0.8,0.8,2.5,4.1], 'format': FixedFormatter(['extremely good','good','slightly good','slightly bad','bad','extremely bad'])},</i></span></p>
<p class="p7"><span class="s7"><span class="Apple-converted-space">              </span></span><span class="s2"><i>#vmin=-5, vmax=5,</i></span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">              </span>xticklabels</span><span class="s3">=</span><span class="s2">[</span><span class="s9">str</span><span class="s2">(hour) </span><span class="s3">+</span><span class="s2"> </span><span class="s10">': '</span><span class="s2"> </span><span class="s3">+</span><span class="s2"> </span><span class="s9">str</span><span class="s2">(</span><span class="s9">int</span><span class="s2">(np</span><span class="s3">.</span><span class="s2">rint(</span><span class="s3">100</span><span class="s2"> </span><span class="s3">*</span><span class="s2"> proba_alive[i][hour]))) </span><span class="s3">+</span><span class="s2"> </span><span class="s10">'%'</span><span class="s2"> </span><span class="s9"><b>for</b></span><span class="s2"> hour </span><span class="s14"><b>in</b></span><span class="s2"> proba_alive</span><span class="s3">.</span><span class="s2">index],</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">              </span>yticklabels</span><span class="s3">=</span><span class="s2">importance_dict[</span><span class="s3">24</span><span class="s2">]</span><span class="s3">.</span><span class="s2">keys())</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">title(</span><span class="s10">'Patient </span><span class="s15"><b>{}</b></span><span class="s10"> survived'</span><span class="s3">.</span><span class="s2">format(i))</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s7">xlabel(</span><span class="s2">'Time passed (hours): Estimated probability of death'</span><span class="s7">)</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s7">savefig(</span><span class="s2">'images/without_gcs/survived/'</span><span class="s7"> </span><span class="s3">+</span><span class="s7"> </span><span class="s9">str</span><span class="s7">(i) </span><span class="s3">+</span><span class="s7"> </span><span class="s2">'_featureimportance.png'</span><span class="s7">)</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>plt</span><span class="s3">.</span><span class="s2">close()</span></p>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 14.0px"><span class="s2"></span><br></h2>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Model feature importances</b></span></h2>
<p class="p16"><span class="s9">print</span><span class="s7">(</span><span class="s2">'Feature coefficients:'</span><span class="s7">)</span></p>
<p class="p4"><span class="s9">dict</span><span class="s2">(</span><span class="s9">zip</span><span class="s2">(data</span><span class="s3">.</span><span class="s2">columns, np</span><span class="s3">.</span><span class="s2">round(lr</span><span class="s3">.</span><span class="s2">coef_[</span><span class="s3">0</span><span class="s2">],</span><span class="s3">2</span><span class="s2">)))</span></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">figure()</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">title(</span><span class="s2">'Predictive role of (high numerical values of) features.'</span><span class="s7">)</span></p>
<p class="p7"><span class="s2"><i>#ticks = [-0.9,-0.3,0.3,0.9]</i></span></p>
<p class="p7"><span class="s2"><i>#vmin = -1.2</i></span></p>
<p class="p7"><span class="s2"><i>#vmax = 1.2</i></span></p>
<p class="p18"><span class="s7">ticks </span><span class="s2">=</span><span class="s7"> [</span><span class="s2">-1.2</span><span class="s7">,</span><span class="s2">-0.4</span><span class="s7">,</span><span class="s2">0.4</span><span class="s7">,</span><span class="s2">1.2</span><span class="s7">]</span></p>
<p class="p4"><span class="s2">vmin </span><span class="s3">=</span><span class="s2"> </span><span class="s3">-1.6</span></p>
<p class="p4"><span class="s2">vmax </span><span class="s3">=</span><span class="s2"> </span><span class="s3">1.6</span></p>
<p class="p4"><span class="s2">sns</span><span class="s3">.</span><span class="s2">heatmap(np</span><span class="s3">.</span><span class="s2">array([lr</span><span class="s3">.</span><span class="s2">coef_[</span><span class="s3">0</span><span class="s2">]])</span><span class="s3">.</span><span class="s2">T,</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span>linewidth</span><span class="s3">=0.1</span><span class="s2">,</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span>cmap</span><span class="s3">=</span><span class="s2">sns</span><span class="s3">.</span><span class="s2">color_palette(</span><span class="s10">"coolwarm"</span><span class="s2">, </span><span class="s3">4</span><span class="s2">),</span></p>
<p class="p16"><span class="s7"><span class="Apple-converted-space">            </span>cbar_kws</span><span class="s3">=</span><span class="s7">{</span><span class="s2">'label'</span><span class="s7">: </span><span class="s2">'predictor'</span><span class="s7">, </span><span class="s2">'ticks'</span><span class="s7">: ticks, </span><span class="s2">'format'</span><span class="s7">: FixedFormatter([</span><span class="s2">'good'</span><span class="s7">,</span><span class="s2">'slightly good'</span><span class="s7">,</span><span class="s2">'slightly bad'</span><span class="s7">,</span><span class="s2">'bad'</span><span class="s7">,])},</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span>vmin</span><span class="s3">=</span><span class="s2">vmin, vmax</span><span class="s3">=</span><span class="s2">vmax,</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span>xticklabels</span><span class="s3">=</span><span class="s2">[],</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span>yticklabels</span><span class="s3">=</span><span class="s2">importance_dict[</span><span class="s3">24</span><span class="s2">]</span><span class="s3">.</span><span class="s2">keys(),</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">            </span>square</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">)</span></p>
<p class="p19"><span class="s19">plt</span><span class="s4">.</span><span class="s19">savefig(</span><span class="s5">'images/without_gcs/overall_feature_importances.png'</span><span class="s19">)</span><span class="s13"><br>
</span></p>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Evolution of prediction distribution over time</b></span></h2>
<p class="p4"><span class="s2">all_proba_plot </span><span class="s3">=</span><span class="s2"> all_proba</span><span class="s3">.</span><span class="s2">copy()</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s9"><b>while</b></span><span class="s2"> all_proba_plot</span><span class="s3">.</span><span class="s2">iloc[</span><span class="s3">0</span><span class="s2">][</span><span class="s10">'true'</span><span class="s2">] </span><span class="s3">==</span><span class="s2"> </span><span class="s3">0</span><span class="s2">:</span></p>
<p class="p4"><span class="s2"><span class="Apple-converted-space">  </span>all_proba_plot </span><span class="s3">=</span><span class="s2"> all_proba_plot</span><span class="s3">.</span><span class="s2">sample(frac</span><span class="s3">=1</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">fig </span><span class="s3">=</span><span class="s2"> plt</span><span class="s3">.</span><span class="s2">figure(figsize</span><span class="s3">=</span><span class="s2">(</span><span class="s3">25</span><span class="s2">,</span><span class="s3">10</span><span class="s2">))</span></p>
<p class="p16"><span class="s7">fig</span><span class="s3">.</span><span class="s7">suptitle(</span><span class="s2">'Predicted scores for survived / deceased by hour.'</span><span class="s7">)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">plot_data_1 </span><span class="s3">=</span><span class="s2"> pd</span><span class="s3">.</span><span class="s2">melt(all_proba_plot, id_vars</span><span class="s3">=</span><span class="s2">[</span><span class="s10">'true'</span><span class="s2">], value_vars</span><span class="s3">=</span><span class="s2">[</span><span class="s3">24</span><span class="s2">, </span><span class="s3">32</span><span class="s2">, </span><span class="s3">40</span><span class="s2">, </span><span class="s3">48</span><span class="s2">, </span><span class="s3">56</span><span class="s2">, </span><span class="s3">64</span><span class="s2">], var_name</span><span class="s3">=</span><span class="s10">'hour'</span><span class="s2">, value_name</span><span class="s3">=</span><span class="s10">'score'</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">plot_data_1[</span><span class="s10">'true'</span><span class="s2">] </span><span class="s3">=</span><span class="s2"> plot_data_1[</span><span class="s10">'true'</span><span class="s2">]</span><span class="s3">.</span><span class="s2">map({</span><span class="s3">0.0</span><span class="s2">: </span><span class="s10">'survived'</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">: </span><span class="s10">'deceased'</span><span class="s2">})</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">plot_data_2 </span><span class="s3">=</span><span class="s2"> pd</span><span class="s3">.</span><span class="s2">melt(all_proba_plot, id_vars</span><span class="s3">=</span><span class="s2">[</span><span class="s10">'true'</span><span class="s2">], value_vars</span><span class="s3">=</span><span class="s2">[</span><span class="s3">72</span><span class="s2">, </span><span class="s3">80</span><span class="s2">, </span><span class="s3">88</span><span class="s2">, </span><span class="s3">96</span><span class="s2">, </span><span class="s3">104</span><span class="s2">, </span><span class="s3">112</span><span class="s2">, </span><span class="s3">120</span><span class="s2">], var_name</span><span class="s3">=</span><span class="s10">'hour'</span><span class="s2">, value_name</span><span class="s3">=</span><span class="s10">'score'</span><span class="s2">)<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s2">plot_data_2[</span><span class="s10">'true'</span><span class="s2">] </span><span class="s3">=</span><span class="s2"> plot_data_2[</span><span class="s10">'true'</span><span class="s2">]</span><span class="s3">.</span><span class="s2">map({</span><span class="s3">0.0</span><span class="s2">: </span><span class="s10">'survived'</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">: </span><span class="s10">'deceased'</span><span class="s2">})</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">subplot(</span><span class="s3">2</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">1</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">sns</span><span class="s3">.</span><span class="s2">violinplot(x</span><span class="s3">=</span><span class="s10">"hour"</span><span class="s2">, y</span><span class="s3">=</span><span class="s10">"score"</span><span class="s2">, hue</span><span class="s3">=</span><span class="s10">"true"</span><span class="s2">, cut</span><span class="s3">=0</span><span class="s2">, scale</span><span class="s3">=</span><span class="s10">'count'</span><span class="s2">, bw</span><span class="s3">=0.2</span><span class="s2">, data</span><span class="s3">=</span><span class="s2">plot_data_1, split</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">)</span></p>
<p class="p10"><span class="s2"></span><br></p>
<p class="p4"><span class="s2">plt</span><span class="s3">.</span><span class="s2">subplot(</span><span class="s3">2</span><span class="s2">,</span><span class="s3">1</span><span class="s2">,</span><span class="s3">2</span><span class="s2">)</span></p>
<p class="p4"><span class="s2">sns</span><span class="s3">.</span><span class="s2">violinplot(x</span><span class="s3">=</span><span class="s10">"hour"</span><span class="s2">, y</span><span class="s3">=</span><span class="s10">"score"</span><span class="s2">, hue</span><span class="s3">=</span><span class="s10">"true"</span><span class="s2">, cut</span><span class="s3">=0</span><span class="s2">, scale</span><span class="s3">=</span><span class="s10">'count'</span><span class="s2">, bw</span><span class="s3">=0.2</span><span class="s2">, data</span><span class="s3">=</span><span class="s2">plot_data_2, split</span><span class="s3">=</span><span class="s9"><b>True</b></span><span class="s2">)</span></p>
<p class="p16"><span class="s7">plt</span><span class="s3">.</span><span class="s7">savefig(</span><span class="s2">'images/without_gcs/violinplot.png'</span><span class="s7">)</span></p>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000; background-color: #ffffff; min-height: 14.0px"><span class="s2"></span><br></h2>
<h2 style="margin: 0.0px 0.0px 0.0px 0.0px; line-height: 15.0px; font: 12.0px 'Helvetica Neue'; color: #000000; -webkit-text-stroke: #000000"><span class="s1"><b>Copy all images to Google Cloud Bucket</b></span></h2>
<p class="p4"><span class="s3">!</span><span class="s2">gsutil -m cp -r images/without_gcs/ gs://hus-aip-tbi/images/</span></p>
</body>
</html>
